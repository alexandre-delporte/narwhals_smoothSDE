\documentclass[11pt]{article}

%%PACKAGES
\usepackage{hyperref} 
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage{bbold}
\usepackage{float}
\usepackage[margin=0.8in]{geometry}
\usepackage[backend=biber,style=authoryear,backref = true]{biblatex}
\usepackage[affil-it]{authblk}
\usepackage{fancyhdr}
\usepackage{comment}
\usepackage{xcolor}
\usepackage{nicematrix}
\usepackage{multirow}
\usepackage{diagbox}
\usepackage{tikz}
\usepackage{yhmath}
\usetikzlibrary{quotes,angles}
\usepackage{pgfplots}
\pgfplotsset{compat = newest}
\pagestyle{fancy}
\fancyhf{}
\fancyhfoffset[L]{1cm} 
\fancyhfoffset[R]{1cm} 
 \setlength{\headheight}{14pt}
\rhead{Greenland narwhal's behavioural responses}
\lhead{\bfseries \today}
\cfoot{\thepage}


%% SHORTCUTS
\DeclareMathOperator{\diag}{diag}
\DeclareMathOperator{\Span}{span}
\DeclareMathOperator{\erf}{erf}
\newcommand {\R}{\mathbb{R}}
\newcommand {\E}{\mathbb{E}}
\newcommand {\prob}{\mathbb{P}}
\newcommand {\N}{\mathbb{N}}
\newcommand {\Z}{\mathbb{Z}}
\newcommand {\1}{\mathbb{1}}


%CITATIONS APPEARANCE
\DeclareCiteCommand{\cite}[\mkbibbold]
{\usebibmacro{prenote}}
{\usebibmacro{citeindex}%
	\printtext[bibhyperref]{\usebibmacro{cite}}}
{\multicitedelim}
{\usebibmacro{postnote}}

\DeclareFieldFormat{boldcite}{\mkbibbold{#1}}

\DeclareCiteCommand{\cite}[\mkbibbold]
{\usebibmacro{prenote}}
{\printtext[brackets]{\usebibmacro{cite}}}
{\multicitedelim}
{\usebibmacro{postnote}}

%TITLE
\title{
 \textbf{Varying coefficients correlated velocity models in complex landscapes with application to narwhal behavioral response to ship exposure and airgun exposure}}



\author{Alexandre Delporte%
	\thanks{\texttt{alexandre.delporte@univ-grenoble-alpes.fr}} }
	\affil{Laboratoire Jean Kuntzmann, Université Grenoble-Alpes, France}
\author{Susanne Ditlevsen%
\thanks{\texttt{susanne@math.ku.dk}}}
\affil{Department of Statistics, University of Copenhagen, Denmark}


\author{Adeline Samson%
	\thanks{\texttt{adeline.leclercq-samson@univ-grenoble-alpes.fr}}}
	\affil{Laboratoire Jean Kuntzmann, Université Grenoble-Alpes, France}


\date{Dated: \today}


\addbibresource{biblio.bib}

\begin{document}

\maketitle


\newpage

\section{Introduction}


Anthropogenic underwater noise in the Arctic environment causes disturbances in the endemic wildlife. More precisely, marine mammals, whose vital functions highly depend on sound perception for communication and orientation, are likely to react to such disturbances. The Arctic Council report \cite{halliday_underwater_2020} emphasizes the need for more knowledge about the impact of underwater noise on Arctic marine mammals. The main sources of noise in the region are vessel traffic, ice breakers, drilling, sonars and seismic airguns used for oil and gas exploration. Among those sources, an increase in vessel traffic is anticipated due to the melting of the ice cap, and seismic airguns are reported to have the largest impact on underwater noise. Two types of consequences can be considered: injury and behavior disturbance. While physical harm is straightforward to assess and mitigate by determining species-specific received sound level thresholds, no canonical method is expected to be found to examine behavior disturbances, due to the multiplicity of contextual variables that can influence a behavioral reaction, and the variety of these reactions.\\
Research recommendations include a particular focus on measurement of behavioral reactions to various type of sound exposure \cite{southall_marine_2008,southall_marine_2019}. Rich behavioral studies typically involve controlled exposure experiments during which animals are exposed to disturbances in a precise and monitored set up where different  statistics can be measured such as GPS positions, depth, sound exposure level, temperature, pressure, heart beat, stroke rate, vocalizations... Numerous surveys have been conducted about beaked whales, which have been regularly implicated in stranding events following sonar exercises \cite{tyack_beaked_2011,cioffi_trade-offs_2022}, belugas \cite{martin_exposure_2023}, sperm whales \cite{madsen_quantitative_2006}, blue whales \cite{friedlaender_preymediated_2016}, and narwhals \cite{heide-jorgensen_behavioral_2021,tervo_narwhals_2021}. \\
A severity scale is defined in \cite{southall_marine_2008} to help assessing which behavioral responses are more likely to alter a population's capacity to survive, reproduce or forage. Changes in movement speed and direction, avoidance reactions as well as modified dive profiles or vocalizations  are ranked between 4 and 7 on a scale out of 9 (9 being stranding events that can directly lead to the death of the animal) depending on the magnitude of the changes and their duration.\\

So far, the studies about narwhals behavioral responses to sound exposure prove that they can exhibit avoidance reactions and have a proclivity to move toward the shore when exposed to seismic airguns \cite{heide-jorgensen_behavioral_2021}. Moreover, a significant decrease in their buzzing rate has been assessed as far as 40 km away from the sound source \cite{tervo_narwhals_2021}. These results are based on controlled exposure experiments conducted in 2017 and 2018 in South-east Greeland, which is home to a declining population of narwhals \cite{garde_biological_2022}.  Though GPS positions are retrieved only when the narwhals emerge to the surface, that is irregularly in time, they have so far been analyzed with discrete time methods relying on linear interpolation to obtain data every second. In \cite{heide-jorgensen_behavioral_2021}, the positions are classified in three states "Far from the shore", "Moving toward shore" and "Close to the shore" at each second, and the dynamic of the states is modeled with a Markov chain, assuming that the current state only depends on the last one in time. An exposure covariate defined as the inverse of the distance to the sound source is then used to model the transition probabilities of the Markov Chain, and the probabilities of being in states "Close to the shore" and "Moving toward the shore" are shown to increase with exposure to the sound, while probability of being in state "Far from the shore" decreases. Additionally, an overall speed increase due to sound exposure is revealed by an analysis of the consecutive GPS positions through a mixed effect model. 
Here, we  make use of a continuous time model to analyse the GPS positions in order to be able to quantify the effect of sound exposure on the speed and the heading of the narwhals in one single model. \\

We focus on continuous-time models defined as a solution of a stochastic differential equation with time-varying coefficients. One widely known model for such data is the continuous-time correlated random walk, also known as the integrated Ornstein-Uhlenbeck or correlated velocity model (CVM) \cite{johnson_continuoustime_2008}. It can be viewed as a special case of velocity potential model, where the potential is a second degree polynomial \cite{preisler_analyzing_2013}. The following formulation of the equations represents an extension of the CVM \cite{johnson_continuoustime_2008}, which involves a rotational component and  is based on biologically interpretable parameters \cite{gurarie_correlated_2017}.
\begin{equation} \left\{
	\begin{array}{l}
		dX(t)=V(t)dt \\
		dV(t)=-\begin{pmatrix} 
			\frac{1}{\tau} & -\omega \\
			\omega & \frac{1}{\tau}
		\end{pmatrix}(V(t)-\mu)dt+\frac{2\nu}{\sqrt{\pi \tau}} dW(t) 
	\end{array}
	\right.
	\label{eq: RACVM equation}
\end{equation}
where $V(t)$ is the horizontal two-dimensional velocity at time $t$ and $X(t)$ is the position, typically in longitude and latitude or in UTM coordinates. Here, $W(t)$ is a two-dimensional brownian motion. 
The parameter $\tau$ is an autocorrelation time scale, $\nu$ controls the norm of the velocity and drives the random variability, $\mu$ is the long term velocity, while $\omega$ is an angular velocity that controls how fast the velocity vector rotates. The case $\omega=0$ corresponds to a standard CVM. In most applications, this model is satisfactory, but in case of tortuous movement, a non-zero value of $\omega$ is sometimes needed \cite{gurarie_correlated_2017,alt_correlation_1990,albertsen_generalizing_2018}. 

Whether or not to include a non-zero mean velocity parameter $\mu$ depends on the specific context of the study. Typically, it would make sense to have $\mu\neq (0,0)$ when examining migratory patterns or avoidance reactions. We follow \cite{gurarie_correlated_2017} and refer to~\ref{eq: RACVM equation} as "Rotational Correlated Velocity Model" (RCVM) in the case $\mu=(0,0)$, and "Rotational Advective Correlated Velocity Model" (RACVM) in the case $\mu \neq (0,0)$.\\


In general, the motion of marine mammals is subject to spatial constraints induced by the coastline. This is particularly the case for the narwhal data we want to analyse: the animals move in a restricted domain that consists in a complex system of fjords in Scoresby Sound (South-East Greenland). Thus, constraints for the shore are needed in the location process $X$. However, this is not the case in model~\ref{eq: RACVM equation}, nor in most of the SDE used for animal movement \cite{johnson_continuoustime_2008,michelot_varying-coefficient_2021,gurarie_correlated_2017}. 
Recently, a reflected version of the CVM has been considered to study sea lion telemetry data \cite{hanks_reflected_2017}.
In this study, simulation of constrained paths is achieved by projecting on the coastline the  points that eventually reach land. Estimation of the SDE parameters then relies on computationally intensive MCMC algorithm (Metroplis-Hastings), and requires high frequency data. Another idea is to add a repulsive potential function in the drift, which is done to constrain ants movement within a box in \cite{russell_spatially_2018}. In our case study, the narwhals move in a complex fjords system, which means that this technique might not be easily replicated because it relies on using very basic boundaries to derive an explicit expression for the potential function. As a consequence, there is a need to develop new models adapted to such spatial constraints.\\
Additionally, the way to model the motion of an animal near the boundary of the domain should be species-specific, accounting for the particular behaviors and spatial use of the studied animal \cite{brillinger_simulating_2003}. For narwhals, it was observed from the data that they have a proclivity to move along the shoreline. Here we propose a new model based on the following idea: as the narwhals approach the shore, at some point they need to rotate to avoid or align with the shoreline. The novelty of this paper consists in modeling the parameter $\omega$ as a smooth function of the distance to the boundary and the angle between the animal's direction and the boundary normal vector. This makes the drift in the velocity equation dependent on the location process $X$ and the boundary of the domain.  \\ %More biblio about estimation methods



Here, we show that the angular velocity  can be estimated as a function of the two covariates in the framework of the \texttt{R} package \texttt{smoothSDE} \cite{michelot_varying-coefficient_2021}. To make this possible, we formulate a state-space model by binding the velocity and location in one single hidden state vector, following \cite{johnson_continuoustime_2008}. Maximum likelihood estimation based on Kalman filter is then performed as for any other model in \texttt{smoothSDE}.\\


Sound exposure is considered to affect only the parameters $\nu$ and $\tau$ in equation \ref{eq: RACVM equation}. This effect is estimated as a smooth function of a sound exposure covariate defined as the inverse of the distance to the ship. This choice of covariate is motivated by \cite{heide-jorgensen_behavioral_2021}. A response model is compared to a baseline model representing the narwhals movement before exposure to the disturbance, that is under normal conditions \cite{michelot_continuous-time_2022}.
The effect of sound exposure is assessed as a deviation in the response model parameters when compared to the baseline model.



To summarize, the main contributions of this paper are
\begin{itemize}
	\item Derivation of a state-space model for the"Rotational Advective Correlated Velocity Model" (RACVM, \ref{eq: RACVM equation}), and addition of this model in the framework of \texttt{smoothSDE} \texttt{R} package, to enable the use of smooth parameters depending on external covariates, and estimation from noisy observations irregularly spaced in time.
	\item Definition of a constrained version of the RCVM for simulation study, where deviations angles from shoreline and distance to shore are used as covariates to constrain the movement within a polygon, and align the velocity with the boundary of the domain.
	\item Application to real narwhal data to assess a behavioural response of the narwhals, using the exposure covariate defined as the inverse of the distance to the sound source.
\end{itemize}

The diffusion models are discussed in Section 2
Then,  Section 3 is dedicated to a comprehensive simulation study, whereas in the last section,we give an overview of the narwhal data available for the analysis and the results of the application of our models to the narwhal data.


\section{Diffusion models}

The dynamic of the true positions of the narwhals is controlled by a stochastic differential equation. First, we recall the standard diffusion model in this context, and then we modify it to include the effect of the shore on the movement.

\subsection{Standard Rotational Advective correlated velocity model (RACVM)}
\label{section: RACVM}

\subsubsection{Solution of the SDE}

We write $A=\begin{pmatrix} 
	\frac{1}{\tau} & -\omega \\
	\omega & \frac{1}{\tau}
\end{pmatrix}$ and recall equation~\ref{eq: RACVM equation}

\begin{equation*} \left\{
	\begin{array}{l}
		dX(t)=V(t)dt \\
		dV(t)=-A(V(t)-\mu)dt+\frac{2\nu}{\sqrt{\pi \tau}} dW(t) 
	\end{array}
	\right.
	\label{eq: RACVM equation bis}
\end{equation*}
where $X$ is the two-dimensional location and $V$ is the two-dimensional velocity.
A more general formulation is considered by \cite{albertsen_generalizing_2018} in which the diffusion matrix is lower triangular matrix with positive diagonal elements whereas and two distinct autocorrelation parameters are considered in both directions allowing for anisotropic movement.
In this case, \cite{albertsen_generalizing_2018} derives an explicit form for the gaussian transition density of the velocity process, where the covariance matrix is expressed using a Kronecker sum \cite{albertsen_generalizing_2018}. Then the Euler-scheme is used to get the transitions of the location process. Here, we claim that under the hypothesis of isotropic movement, with diagonal diffusion matrix as in equation ~\ref{eq: RACVM equation}, both the velocity and the position processes have a closed form formula. Though this model is discussed in \cite{gurarie_correlated_2017}, we found no mention of these explicit formulas. \\

The transition density for the velocity process is such that 
\begin{equation}V(t+\Delta) \vert V(t)=v \sim \mathcal{N}\left( (I_2-\exp(-A\Delta))\mu + \exp(-A\Delta)v, \frac{2\nu^2}{\pi}(1-e^{-2\frac{\Delta}{\tau}}) I_2 \right) 
\end{equation}


where $\exp(-A\Delta)=e^{\frac{-\Delta}{\tau}} \begin{pmatrix} \cos(\omega \Delta) & \sin(\omega \Delta) \\ -\sin(\omega \Delta) & \cos(\omega \Delta) \end{pmatrix}$ is a weighted rotation matrix of angle $-\omega \Delta$.
Intuitively, the next velocity is a weighted mean of the long term mean velocity $\mu$ and the previous velocity $v(t)$ rotated by an angle $-\omega \Delta$.


%stationary distribution, distribution of the norm, distribution of the phase
This velocity process has stationary distribution $\mathcal{N}\left(\mu,\frac{2\nu^2}{\pi} I_2\right)$ \cite{gurarie_correlated_2017}. After the velocity process has reached stationarity, that is typically for $t \geq 3\tau$, $\vert \vert v(t) \vert \vert$ follows a Rice distribution with mean parameter $\vert \vert \mu \vert \vert$ and variance parameter $\frac{2\nu^2}{\pi}$. In the special case $\mu=(0,0)$, this means that $\E(\vert \vert v(t) \vert \vert)=\nu$ and motivates the interpretation of $\nu$ as the mean velocity norm of the movement.

By integrating the velocity equation over time one gets the following conditional distribution for the location process :
\begin{equation}
	X(t+\Delta) \vert X(t)=x, V(t)=v \sim \mathcal{N}\left(x+\mu \Delta+A^{-1} \left( I_2-\exp(-A\Delta)\right)(v-\mu),Q(\Delta)\right)  
\end{equation}
Here, the covariance matrix $Q(\Delta)$ has an explicit form.

\[
Q(\Delta)=\left( \Delta-2 \frac{\omega \sin(\omega \Delta)-\frac{1}{\tau} \cos(\omega \Delta)}{\frac{1}{\tau^2}+\omega^2 } \exp\left( -\frac{\Delta}{\tau} \right) +\frac{\tau}{2} \left( \frac{\omega^2-\frac{3}{\tau^2}}{\frac{1}{\tau^2}+\omega^2}-\exp\left( -\frac{2\Delta}{\tau}\right)\right) \right) I_2
\]
The location process is not markovian, but the whole process $(x(t), v(t))^\top$ is.
Both components of the location and velocity processes are independent.
and one can check that for $\omega=0$, the formulas match the ones of the  CTCRW model \cite{johnson_continuoustime_2008}. Figure~\ref{fig: sample RACVM} shows two samples of a RCVM along with the histograms of the empirical velocity norm and phase. Derivation of the formulas given in this paragraph is detailed in appendix~\ref{section: detailed RACVM computations}.\\


%samples with non zero and zero mu

\begin{figure}[H]
	\centering
	\begin{subfigure}{0.48\textwidth}
		\centering
		\includegraphics[scale=0.3]{images/rcvm/tau5_nu5_omega1mu11_sigmaobs0.03 .png}
		\caption{}
	\end{subfigure}
	\begin{subfigure}{0.48\textwidth}
		\centering
		\includegraphics[scale=0.3]{images/rcvm/hspeed_histo_tau5_nu5omega1_mu11_sigmaobs0.03 .png}
		\caption{}
	\end{subfigure}
	\caption{(a) Samples of a RACVM with parameters $\tau=5 h$, $\nu=5$ km/h,$\omega=1$ rad/h, $\mu=(1,0)$ km/h. The black cross indicates the starting point of the process. The samples were obtained from the exact transition densities. (b) Histogram of the empirical velocities obtained from the samples, along with the theoretical probability density function.}
	\label{fig: sample RACVM}
\end{figure}


\subsubsection{State-space model}
In most applications, it is needed to consider measurement errors through a state-space model. We suppose that positions are observed at discrete times $t_j$, $j \in \{1,\cdots, n\}$. $Y_j$ is the random vector representing the observed position at time $t_j$, while $X_j=X(t_j)$ is the true position at time $t_j$.

\begin{equation}  \left\{
	\begin{array}{l}
		Y_j=X_j+\varepsilon_j \quad j \in \{1,\cdots,n\}\\
		\varepsilon_j \underset{i.i.d}{\sim} \mathcal{N}(0,\sigma_{obs}^2)  \\
		dX(t)=V(t)dt  \\
		dV(t)=-A(V(t)-\mu)dt+\frac{2\nu}{\sqrt{\pi \tau}} dW(t) 
	\end{array}
	\right.
\end{equation}



Here, we consider parameters $\tau$, $\nu$, $\mu$ and $\omega$ depending on time.
We make the approximation that these parameters are constant on each time step $[t_j,t_{j+1}]$ . Denote $\Delta_j=t_{j+1}-t_j$, $V_j=V(t_j)$, $V_j=V(t_j)$, $\mu_j=\mu(t_j)$, $\tau_j=\tau(t_j)$, $\nu_j=\nu(t_j)$,$\omega_j=\omega(t_j)$ and $A_j=\begin{pmatrix} 
	\frac{1}{\tau_j} & -\omega_j \\
	\omega_j & \frac{1}{\tau_j}
\end{pmatrix}$.

\begin{equation}
	\forall j \in \{1, \cdots, n\} \quad 
	\left\{ \begin{array}{l}
		V_{j+1}=\mu_j +\exp(-A_j\Delta_j)(V_j-\mu_j)+\zeta_j \\
		X_{j+1}=X_j+\mu_j \Delta_j+A_j^{-1}(I_2-\exp(-A_j\Delta_j))(_Vj-\mu_j)+\xi_j
	\end{array}\right. \\
	\label{eq: RCVM autoregressive formula}
\end{equation}


where $\zeta_j$ and $\xi_j$ are centered normal random vectors.
Denote $\alpha_j=\begin{pmatrix} X_{j,1}  & X_{j,2} & V_{j,1} & V_{j,2}\end{pmatrix}^\top$. The state space equations are

\[
\left\{
\begin{array}{l}
	Y_j=Z\alpha_j+\varepsilon_j \\
	\alpha_{j+1}=T_j \alpha_j+B_j \mu_j + \eta_j
\end{array}
\right.\]
where the link matrices are 
\[Z=\begin{pmatrix} I_2 & 0_{2,2}\end{pmatrix} \quad  T_j=\begin{pmatrix} I_2 & A_j^{-1}(I_2-\exp(-A_j \Delta_j)) \\ 0_{2,2} & \exp(-A_j \Delta_j) \end{pmatrix} \quad B_j=\begin{pmatrix}
	\Delta_j I_2-A_j^{-1}(I_2-\exp(-A_j\Delta_j)) \\
	I_2-\exp(-A_j\Delta_j)\end{pmatrix}
\]


$\varepsilon_j \sim \mathcal{N}(0,\sigma_{obs}^2 I_2)$ and the vector $\eta_j=\begin{pmatrix} \xi_{j,1} & \xi_{j,2} & \zeta_{j,1} & \zeta_{j,2} \end{pmatrix}^\top$ is a 4 dimensional normal random vector, with mean zero. Its covariance matrix $Q_j$ can be computed explicitly.
\begin{equation}
	Q_j=\begin{pmatrix}
		M_j & L_j \\
		L_j & N_j
	\end{pmatrix}
	\label{eq: state space covariance}
\end{equation}
where $M_j$, $N_j$and $L_j$ are block matrices of size $2 \times 2$ such that 
\[M_j=\left( \Delta-2 \frac{\omega_j \sin(\omega_j \Delta_j)-\frac{1}{\tau_j} \cos(\omega_j \Delta_j)}{\frac{1}{\tau_j^2}+\omega_j^2 } \exp\left( -\frac{\Delta_j}{\tau_j} \right) +\frac{\tau_j}{2} \left( \frac{\omega_j^2-\frac{3}{\tau_j^2}}{\frac{1}{\tau_j^2}+\omega_j^2}-\exp\left( -\frac{2\Delta_j}{\tau_j}\right)\right) \right)I_2\]

\[N_j=\frac{2\nu_j^2}{\pi}\left(1-e^{-\frac{2 \Delta_j}{\tau_j}}\right)I_2\]

\[L_j=\begin{pmatrix} l_1 & l_2 \\
	l_2 & l_1\end{pmatrix}\]
where 
\[l_1=\frac{4\nu_j^2}{2 \pi \tau_j \times \left( \frac{1}{\tau_j^2}+\omega_j^2\right)} \times \left( 1+\exp\left( -\frac{2\Delta_j}{\tau_j}\right)-2\exp\left( -\frac{\Delta_j}{\tau_j}\right)-2\exp\left( -\frac{\Delta_j}{\tau_j}\right) \cos(\omega_j \Delta_j)\right)\]
\[l_2=\frac{4\nu_j^2}{2 \pi \tau_j \times \left( \frac{1}{\tau_j^2}+\omega_j^2\right)} \times\left( \exp\left( -\frac{\Delta_j}{\tau_j}\right) \sin(\omega_j \Delta_j)-\frac{\omega_j \tau_j}{2} \left(1-\exp\left( -2 \frac{\Delta_j}{\tau_j}\right) \right)\right)\]

One can check that for $\omega_j=0$, the formulas match the ones of the CTCRW model \cite{johnson_continuoustime_2008}.
This state-space formulation is the basis for fast inference of time-varying parameters using the Kalman filter. This is the technique used in the \texttt{R} package \texttt{smoothSDE} \cite{michelot_varying-coefficient_2021} the special case $\omega=0$. Therefore, we extend this inference method to the more general model~\ref{eq: RACVM equation}.

\subsection{Constrained rotational correlated velocity model}
\label{section: CRCVM}

Unconstrained movement of animals that do not exhibit a clear rotational movement, as it is often the case for marine mammals, is generally modeled through a CVM, that is equation~\ref{eq: RACVM equation} with $\omega=0$.
To get a constrained version of the CVM, it is natural to make use of a RCVM when the process is close to the shore and the velocity is pointing toward the shore to represent how the animals turn in reaction to the shore.
This can be achieved by choosing a smooth function that is zero far away from the shore and non zero close to the shore for $\omega$.
Denote $\mathcal{D} \subset \R^2$ the polygon defining the domain of the process $X$. The new formulation of the equation is 
\begin{equation} \left\{
	\begin{array}{l}
		dX(t)=V(t) dt \\
		dV(t)=-A(X(t),V(t))V(t)dt+\frac{2\nu}{\sqrt{\pi \tau}} dW(t) 
		
	\end{array}
	\right.
	\label{eq: CRCVM equation}
\end{equation}

Here, $A(X(t),V(t))=\begin{pmatrix} 
	\frac{1}{\tau} & -\omega(t) \\
	\omega(t) & \frac{1}{\tau}
\end{pmatrix}$
where $\omega(t)=f_{\omega}(D_{shore}(t),\Theta(t))$, $D_{shore}(t)=d(X(t),\partial\mathcal{D})$ is the distance to the boundary of the domain,
$\Theta(t)=\widehat{(X(t)-p(t),V(t))}$, $p(t)$ is the projection of $X(t)$ on $\partial \mathcal{D}$ and $f_{\omega}$ is a smooth function from $\R^{+} \times [-\pi,\pi]$ into $\R$.

Solving explicitly such a model is out of reach due to the non-linearity induced by the distance to the shore and the angle, but it is possible to get an approximate solution.
For any $t \geq 0$ and $\Delta>0$, if $\Delta$ is small enough, we can use the approximations
\[\forall s \in [t,t+\Delta], D_{shore}(s) \simeq D_{shore}(t) \quad \Theta(s)\simeq \Theta(t)\]
In this case, the formulas of section~\ref{section: RACVM} are still valid.
The question still hanging is : what are the conditions on the function $f_{\omega}$ to ensure that the process is constrained ?
We don't formulate a comprehensive answer here, but only give examples of interpretable smooth functions that result in constrained samples of $X$.
An important spatial scale of the rotational movement is $\rho=\frac{\nu}{\omega}$ : this is the diameter of rotation. For the process to be constrained, one condition would be that $\rho$ always remains significantly lower than $D_{shore}$. We hint that the condition should also include the regularity of the domain, but this will be a subject for further work. Moreover, a rotation needs to be considered only near the boundary of the domain, that is when $D_{shore}$ approached $0$, and when the narwhal is heading in the direction of the shore, that is for $\Theta \in \left[\frac{\pi}{2},\pi\right] \cup \left[-\pi,-\frac{\pi}{2}\right]$.
The closer we are to the shore, the faster the velocity should rotate. 
whereas at a certain distance from the coast, there should be no further effect of the shore, meaning that $\omega$ should be $0$. Far from the coast, the movement model is simply an integrated Ornstein-Uhlenbeck process, as in the unconstrained case \cite{johnson_continuoustime_2008}.
A weight based on the distance to the shore can be defined as follows :
\[c(D_{shore})=\exp\left(-\kappa \times \left(\frac{D_{shore}}{D_0}\right)^2\right)\mbox{ for some } D_0>0 \mbox{ and } \kappa>0\]

Based on this weight, a relationship between $f_{\omega}$ and the angle $\Theta$ and the distance to the shore $D_{shore}$ can be formulated as follows :

\begin{equation}
f_{\omega}(\theta,D_{shore})=\frac{\omega_0}{2}\left(\tanh(\lambda(\theta+\theta^{*}))+\tanh(\lambda(\theta-\theta^{*})))\right)\times c(D_{shore})
\label{eq: smooth omega}
\end{equation}
for some $\omega_0 \in \R$, $\lambda>0$, $\theta^* \in [0,2\pi]$.

This parametrization of $\omega$ is only motivated by the observations above, and do not pretend to be optimal. Any smooth function that meets minimum requirements could be used instead. The general model is very flexible, and different species-specific behaviours could be described. An alternative is to specify the smooth function $f_{\omega}$ using spline basis functions. \\
Figure~\ref{fig: trueomega} shows a smooth function obtained from~\ref{eq: smooth omega} for the parameter $\omega$. Figure~\ref{fig: splineomega} shows three spline basis functions and a smooth function $f_{\omega}$ obtained as a combination of these basis functions.


\begin{figure}[H]
	\centering
		\centering
		\includegraphics[scale=0.25]{images/simulation study/true_smooth_omega_rect.png}
		\caption{$\omega$ (unit : $rad \cdot h^{-1}$) as a smooth function of $\Theta$ and $D_{shore}$. Values of $D_{shore}$ are in $km$ and values of $\Theta$ are in $rad$.
			(a) $D_0=0.3$ km, $\lambda=1.5$, $\kappa=0.5$ and $\omega_0=\pi$ rad/min}
		\label{fig: trueomega}
\end{figure}

\begin{figure}[H]
	\begin{subfigure}{0.48\textwidth}
		\centering
		\includegraphics[scale=0.12]{images/simulation study/spline_smooth_omega_rect.png}
		\caption{}
	\end{subfigure}
	\begin{subfigure}{0.48\textwidth}
		\centering
		\includegraphics[scale=0.12]{images/simulation study/spline_smooth_omega_rect.png}
		\caption{}
	\end{subfigure}
	\caption{}
	\label{fig: splineomega}
\end{figure}




\begin{figure}[H]
	\centering
	\begin{subfigure}{0.48\textwidth}
		\centering
		\includegraphics[scale=0.4]{images/simulation study/illustrative_sample_rect.png}
		\caption{}
	\end{subfigure}
	\begin{subfigure}{0.48\textwidth}
		\centering
		\includegraphics[scale=0.4]{images/simulation study/illustrative_sample_fjords.png}
		\caption{}
	\end{subfigure}
	\caption{Samples of the CRCVM in different domains. x and y axis are in metres and initial positions are indicated by a red cross and red point represent the nearest points on the boundary of the domain (a) One sample three day sample with time step $h=1$ min in a rectangular domain (b) One sample three day sample with time step $h=1$ min in Scoresby Sound fjords system in South-East Greenland}
	\label{fig: samples_rect_CRCVM}
\end{figure}




\section{Simulation study}

\label{section: simulation study}
%samples and estimation
%discussion about tensor splines vs additive splines




\subsection{Simulation of constrained motion}
In order to test the constrained models we simulated the CRCVM process within different domains for smooth parameters $\omega$ depending on the angle $\Theta$ and the distance to the boundary of the domain $D_{shore}$.\\


$3$ days long trajectories were sampled in a rectangular domain with sides of length $8$ km from the CRCVM with the smooth function for $\omega$ displayed in figure~\ref{fig: trueomega}(a) and other parameters kept constant ($\nu = 4$ km/h, $\tau=1$ h). For each trajectory, initial velocity was set to $0$ and initial position was uniformly sampled in the rectangular domain, at least $500$ metres away from the boundary. Time steps were chosen equal to $1$ min for high frequency and subsampled to $5$ minutes for low frequency. Gaussian measurement errors with low standard deviation $\sigma_{obs}=3$ m and large standard deviations $\sigma_{obs}=30$ m were added to provide the actual observations. Of these $100$ trajectories, none reach the boundary for $\sigma_{obs}=3$ m and only one for $\sigma_{obs}=30$m. However, too small values of $D_0$ and $\omega_0$, as well as too large measurement errors may produce samples that reach the boundary of the domain. Figure~\ref{fig: samples_rect_CRCVM} shows some of the 100 samples obtained in the rectangular domain. \\


10 trajectories were also simulated in Scoresby Sound fjords system in which the narwhals move under constraints. The parameter $\omega$ was defined as the smooth function displayed in~\ref{fig: trueomega}(b). Again, for each trajectory, initial velocity was set to $0$ and initial position was uniformly sampled within the sea, with the requirement that it should be at least $500$ metres away from the shore. Time steps were also kept constant, equal to $1$ min for high frequency and subsampled to $5$ min for low frequency. None of the 10 trajectories reached land. Note that if time steps are too large, the assumption of constant covariates between observations is very likely to be violated due to the steepness of the shoreline, resulting in samples that reach land very often. For the fjords system, this already happens if we try to sample directly with $5$ min time steps. Constrained samples within the geometry of Scoresby sound fjords are shown in~\ref{fig: samples_fjords_CRCVM}. Moreover, sampling within the fjords takes much more time than within the rectangular domain, since it is necessary to loop over each polygon of the geometry to compute the nearest shore point for each new position. 



\subsection{Estimation with tensor splines}


The samples from previous section were used to estimate the function $\omega$, both in the rectangular domain and in Scoresby Sound fjords system. Covariates $E_{shore}$ and $\Theta$ were computed from the observed positions and the smooth parameter $\omega$ was estimated using bivariate tensor splines of these covariates, given by the function \texttt{te} in \texttt{R}. The marginal spline degree of freedom was set to $5$ for each covariate, which corresponds to $3$ knots in the splines. Hence, $25$ coefficients (including the intercept) were to be estimated. The other parameters of the diffusion were supposed to be known, as well as the measurement error. Underestimation of the smooth parameter $\omega$ is observed close to the shore as $\Theta$ approaches $\pm \pi$ (movement toward the shore). This is easily seen in figures \ref{fig: marginal_estimates_rect_CRCVM}(a)-(b) and and \ref{fig: marginal_estimates_fjords_CRCVM}(a)-(b).


As measurement error grows, the covariates that are estimated from the observed positions are becoming less accurate, which makes estimation more challenging. THta is why slight differences in figures ~\ref{fig: marginal_estimates_rect_CRCVM}(a)-(b).

\begin{figure}[H]
	\centering
	\begin{subfigure}{0.48\textwidth}
		\centering
		\includegraphics[scale=0.3]{images/simulation study/omega_crcvm_rect_hf_ne1.png}
		\caption{}
	\end{subfigure}
	\begin{subfigure}{0.48\textwidth}
		\centering
		\includegraphics[scale=0.3]{images/simulation study/omega_crcvm_rect_hf_ne1.png}
		\caption{}
	\end{subfigure}
	\caption{Estimates of the smooth parameter $\omega$ as a function of $D_{shore}$ and $\Theta$ in the rectangular domain. (a)-(b): Estimation from data with time step $h=1$ min (high frequency) with respective measurement errors standard deviation $\sigma_{obs}=3$ m and $\sigma_{obs}=30$ m.}
	\label{fig: estimate_rect_CRCVM}
\end{figure}


\begin{figure}[H]
	\centering
	\begin{subfigure}{0.48\textwidth}
		\centering
		\includegraphics[scale=0.3]{images/simulation study/crcvm_rect_hf_ne1_omega_close.png}
		\caption{}
	\end{subfigure}
	\begin{subfigure}{0.48\textwidth}
		\centering
		\includegraphics[scale=0.3]{images/simulation study/crcvm_rect_hf_e1_omega_close.png}
		\caption{}
	\end{subfigure}
	\begin{subfigure}{0.48\textwidth}
		\centering
		\includegraphics[scale=0.3]{images/simulation study/crcvm_rect_hf_ne1_omega_far.png}
		\caption{}
	\end{subfigure}
	\begin{subfigure}{0.48\textwidth}
		\centering
		\includegraphics[scale=0.3]{images/simulation study/crcvm_rect_hf_e1_omega_far.png}
		\caption{}
	\end{subfigure}
	\caption{Estimates of the smooth parameter $\omega$ as a function of $\Theta$ only, in the rectangular domain. The red curve represents the true value of $\omega$. (a)-(b): Fixed distance $D_{shore}=0.5$ km with respective measurement errors $\sigma_{obs}=3$ m and $\sigma_{obs}=30$ m. (c)-(d): Fixed distance $D_{shore}=3$ km with respective measurement errors $\sigma_{obs}=3$ m and $\sigma_{obs}=30$ m.}
\label{fig: marginal_estimates_rect_CRCVM}
\end{figure}



\begin{figure}[H]
	\centering
	\begin{subfigure}{0.48\textwidth}
		\centering
		\includegraphics[scale=0.3]{images/simulation study/omega_crcvm_fjords_hf_ne1.png}
		\caption{}
	\end{subfigure}
	\begin{subfigure}{0.48\textwidth}
		\centering
		\includegraphics[scale=0.3]{images/simulation study/omega_crcvm_fjords_hf_ne1.png}
		\caption{}
	\end{subfigure}
	\caption{Estimates of the smooth parameter $\omega$ as a function of $D_{shore}$ and $\Theta$ in Scoresby Sound fjords system. (a)-(b): Estimation from data with time step $h=1$ min (high frequency) with respective measurement errors standard deviation $\sigma_{obs}=3$ m and $\sigma_{obs}=30$ m.}
	\label{fig: estimate_fjords_CRCVM}
\end{figure}


\begin{figure}[H]
	\centering
	\begin{subfigure}{0.48\textwidth}
		\centering
		\includegraphics[scale=0.3]{images/simulation study/crcvm_fjords_hf_ne1_omega_close.png}
		\caption{}
	\end{subfigure}
	\begin{subfigure}{0.48\textwidth}
		\centering
		\includegraphics[scale=0.3]{images/simulation study/crcvm_fjords_hf_ne1_omega_close.png}
		\caption{}
	\end{subfigure}
	\begin{subfigure}{0.48\textwidth}
		\centering
		\includegraphics[scale=0.3]{images/simulation study/crcvm_fjords_hf_ne1_omega_far.png}
		\caption{}
	\end{subfigure}
	\begin{subfigure}{0.48\textwidth}
		\centering
		\includegraphics[scale=0.3]{images/simulation study/crcvm_fjords_hf_ne1_omega_far.png}
		\caption{}
	\end{subfigure}
	
	\caption{Estimates of the smooth parameter $\omega$ as a function of $\Theta$ only, in Scoresby Sound fjords system. The red curve represents the true value of $\omega$. (a)-(b): Fixed distance $D_{shore}=0.5$ km with respective measurement errors $\sigma_{obs}=3$ m and $\sigma_{obs}=30$ m. (c)-(d): Fixed distance $D_{shore}=3$ km with respective measurement errors $\sigma_{obs}=3$ m and $\sigma_{obs}=30$ m.}
	\label{fig: marginal_estimates_fjords_CRCVM}

\end{figure}


\section{Application to narwhals behavioral response}


\subsection{Description of the movement data}

The dataset analysed in this paper has been the subject of several studies, focusing mainly on vocalizations and avoidance reactions \cite{heide-jorgensen_behavioral_2021,tervo_narwhals_2021}. 
Six male narwhals were equipped with FastLoc GPS receivers in August 2018 in Scoresby Sound fjord system in South-East Greenland by biologists from the Greenland Institute of natural ressources, with the help of local Inuit hunters. The Scoresby Sound fjord system
is known to be the summer residence for an isolated population of narwhals.
Here we recall briefly how the data has been retrieved. For more details about the study area and the tagging of the animals, the reader may refer to \cite{heide-jorgensen_behavioral_2021}. 
An offshore patrol vessel military ship was sailed to shoot airguns underwater between August 25 and September 1. It was equipped with two Sercel G-guns at 6m depth and moved at a speed of 4.5 knots. The guns were fired synchronously every 80 s, and the GPS navigation system recorded the location of every shot. 
Data includes narwhals's latitude and longitude, distance relative to the ship in metres, GPS time, distance to the shore in metres. GPS positions are known only at specific times when the narwhals get close to the sea surface. The median time step between two GPS measurements in the data is about $5$ minutes and only $0.3 \%$ of the time steps reach more than two hours, with a maximum at more than $4$ hours. Figure \ref{fig:alltimestepshisto} shows the distribution of time steps in the data. While statistical analysis in \cite{heide-jorgensen_behavioral_2021} relied on positions linearly interpolated at each second, here we only consider the actual GPS measurements with irregular time steps.



Experiments were divided into unexposed periods - for which the narwhals are not in line of sight with the ship - trial periods - when the narwhals are exposed to the ship and airguns are shot - and intertrial periods - when the narwhals are exposed to the ship but airguns are not shot. These periods are indicated by a categorical variable $T_{ship}$ in the dataset. Figure~\ref{fig: trials and intertrials distributions} shows how these periods are distributed among the $6$ narwhals that were tracked. In this analysis, we do not distinguish between Trial and Intertrial periods, and treat them both as exposure periods, where the degree of exposure depends on the narwhals positions relative to the ship.

\begin{figure}[H]
	\centering
	\begin{subfigure}{0.49\textwidth}
		\centering
		\includegraphics[width=0.9\textwidth]{images/data_exploration/trials.png}
		\caption{Trial and Intertrial periods for each narwhal}
		\label{fig: trials and intertrials distributions}
	\end{subfigure}
	\begin{subfigure}{0.49\textwidth}
		\centering
		\includegraphics[width=0.9\textwidth]{images/data_exploration/all_time_steps_histo}
		\caption{Histogram of time steps}
		\label{fig:alltimestepshisto}
	\end{subfigure}
\end{figure}


For each narwhal, the entire track is split into a period before exposure defined as the period before the narwhal gets in line of sight with the ship for the first time, and a period "after" exposure, starting after the narwhal has been in line of sight with the ship for the first time. We keep only GPS measures 24 
hours after tagging, to avoid any tagging effects on the narwhals's movement, as recommended in \cite{heide-jorgensen_behavioral_2021}.
Measures that result in a velocity higher than $20$ km/h were also discarded (only 2 data points for the same narwhal track).
Overall, $4192$ GPS positions are kept for the analysis and projected to UTM coordinates zone 26. The splitting between data before and after exposure results in $935$ measures before exposure and $3257$ measures after exposure. Table~\ref{table: data distribution} in Appendix shows how the data is distributed among the different narwhals. Figure~\ref{fig: tracks before and after exposure} shows all the tracks before and after exposure.


\subsection{Notations and definition of the covariates}


For each narwhal $i \in \{1,\cdots,N\}$ with $N=6$, we denote $n_i$ the total number of observations, which can be decomposed in $n_i=n_{i,pre}+n_{i,post}$ where $n_{i,pre}$ is the number of observations before exposure, and $n_{i,post}$ is the number of observations after exposure. We suppose that the position is observed at times $t_{i1}, t_{i2}, \cdots,t_{in_i}$ and  for $j \in \{1,\cdots,n_i\}$, we denote $y_{ij}=\begin{pmatrix} y_{ij1} & y_{ij2} \end{pmatrix}^\top$ the observed GPS position at time $t_{ij}$, converted in Easting and Northing.

The land geometry for the specific region in South-East Greenland is gathered from \href{https://www.openstreetmap.org/#map=11/70.4029/-27.2928}{OpenStreetMap} database. The land polygons define the boundaries of the domain $\mathcal{D}$ in which the narwhals can move. The closest point on the shoreline to the observed position $y_{ij}$  is denoted $p_{ij}$, and the distance to this point, denoted $\hat{D}^{shore}_{ij}$ in the sequel, is considered a close approximation of the actual distance to the boundary $D^{shore}_{ij}$. The resulting values range from $0$ to $7.5$ km. About $9\%$ of the GPS measurements in the dataset turned out to be on land. This is primarily attributed to inaccuracies in the shoreline maps rather than errors in GPS measurements. For constrained movement models, these points are ignored. Then, exposure to the shore is defined with the following formula
\begin{equation}
	\left\{
	\begin{array}{ll}
		E^{shore}_{ij}=0 & \mbox{if } D^{shore}_{ij}>D_{ref} \\
		E^{shore}_{ij}=\frac{1}{D_{shore}(t_j)} & \mbox{if } D^{shore}_{ij} \leq D_{ref}
	\end{array}
	\right.
	\label{eq: exp shore definition}
\end{equation}
where the reference threshold $D_{ref}$ is chosen equal to $0.5$ km. We denote $\hat{E}^{shore}_{ij}$ the approximation of $E^{shore}_{ij}$ obtained by replacing the true distance $D^{shore}_{ij}$ by $\hat{D}^{shore}_{ij}$.
The angle between the narwhal's heading and the shoreline, denoted $\Theta_{ij}$, is estimated as the angle $\hat{\Theta}_{ij}$ between the observed empirical velocity $\hat{v}_{ij}=\frac{y_{i,j+1}-y_{ij}}{\Delta_j}$, where $\Delta_j=t_{i,j+1}-t_{ij}$, and the vector $n_{ij}=y_{ij}-p_{ij}$. This is illustrated in figure~\ref{fig: illustration nearest shore points}. A value $\Theta_{ij}=\pm \frac{\pi}{2}$ indicates movement parallel to the shore, while $\Theta_{ij} \in \left]\frac{\pi}{2},\pi\right] \cup \left[-\pi,-\frac{\pi}{2}\right[$ indicates movement toward the shore. 
The distance from the ship, denoted $D^{ship}_{ij}$, is computed from the GPS ship and narwhals's positions. The values are comprised between $2.68$ and $63.8$ km.
Histograms of the distance to the ship and the distance to the shore are shown in figure~\ref{fig: distance to shore and distance to ship histograms}.

\begin{figure}[H]
	\centering
	\begin{tikzpicture}
		%boundary
		\draw[gray, thick] (0,0) -- (0,4);
		%position
		\draw[red,fill=gray] (2,2) circle (.3ex);
		%nearest shore point
		\draw[red,fill=red] (0,2) circle (.3ex);
		%velocity
		\draw[->,gray] (4,0) -- (2,2);
		\draw[->,gray,dashed,thick] (2,2) coordinate (O) -- (0,4) coordinate (A);
		%normal vector
		\draw[->,red,dashed] (O) -- (4,2) coordinate (B);
		%trigonometric circle
		\draw[gray,dashed] (2,2) circle (2cm);
		%angle 
		\pic[draw=orange,->,angle eccentricity=1.2,angle radius=0.5cm] {angle=B--O--A};
		
		%nodes
		\node[left] at (0,0) {$\partial \mathcal{D}$};
		\node[left] at (0,2) {$p_{ij}$};
		\node[left] at (1.2,2.8) {$\hat{v}_{ij}$};
		\node[below] at (1.8,2) {$y_{ij}$};
		\node[below,red] at (3,2) {$\vec{n}_{ij}$};
		
		\node[above,orange] at (2.3,2.3) {$\hat{\Theta}_{ij}$};
	\end{tikzpicture}
	\caption{Example of nearest shore point and angle $\Theta$. $\partial D$ represents the boundary of the domain, $y_{ij}$ is the observed GPS position of narwhal $i$ at time $t_{ij}$.}
	\label{fig: illustration nearest shore points}
\end{figure}
\begin{figure}[H]
	\centering
	\begin{subfigure}{0.48\textwidth}
		\centering
		\includegraphics[scale=0.45]{images/data_exploration/Dship_histo.png}
		\caption{Histograms of the distance to the ship \\ for each narwhal}
	\end{subfigure}
	\begin{subfigure}{0.48\textwidth}
		\centering
		\includegraphics[scale=0.45]{images/data_exploration/Dshore_histo.png}
		\caption{Histograms of the distance to the shore \\ for each narwhal}
	\end{subfigure}
	\caption{Distance to ship and distance to shore covariates}
	\label{fig: distance to shore and distance to ship histograms}
\end{figure}


Exposure to ship covariate for narwhal $i$ at time $t_{ij}$ , denoted $E^{ship}_{ij}$, is defined as the inverse of the distance to the ship (in km) \cite{heide-jorgensen_behavioral_2021}.
$D^{ship}$ is only known when the narwhal is in line of sight with the boat, so that exposures are set to $0$ when this is not this case. This implies that the effect of the ship noise on the narwhals's movement is only considered in this specific case in the whole study, though it is very likely that narwhals can perceive the disturbance even when they are not clearly in line of sight with the sound source. This provides a conservative estimate of the effect of the noise exposure. The covariate $E^{ship}$ is meant to be a proxy for sound exposure levels received by the narwhals. Reasonably, the closer the narwhal is to the ship, the more it can hear its sound, and the greater the exposure. Exposure levels for each narwhals are displayed in figure~\ref{fig: realexpthroughtime}. All the relevant covariates that will be used for the analysis of narwhals movement are summarized in table \ref{tab: covariates}.


\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{images/data_exploration/realExp_through_time}
	\caption{}
	\label{fig: realexpthroughtime}
\end{figure}



\begin{table}[H]
	\centering
	\begin{tabular}{|c|c|p{8cm}|c|}
		\hline
		Covariate & Unit & Description & Domain \\
		\hline
		$D_{ship}(t)$ & km & distance in kilometers between the narwhal and the ship at time $t$ & $\R^+$ \\
		\hline
		$T_{ship}(t)$  & categorical & $0$ when there is no trial, $1$ if it is an intertrial period, and $2$ when it is a trial period & $\{0,1,2\}$\\
		\hline
		$E_{ship}(t)=\frac{1}{D_{ship}(t)}$ & $km^{-1}$ & global exposure level of the narwhal to the ship disturbance at time $t$ & $\R^+$ \\
		\hline
		$E_{ship,I}(t)=\frac{1}{D_{ship}(t)}\mathbb{1}_{T_{ship}(t)=1}$& $km^{-1}$ & intertrial exposure level of the narwhal to the ship disturbance at time $t$ & $\R^+$ \\
		\hline
		$E_{ship,T}(t)=\frac{1}{D_{ship}(t)}\mathbb{1}_{T_{ship}(t)=2}$ & $km^{-1}$ & trial exposure level of the narwhal to the ship disturbance at time $t$. & $\R^+$\\
		\hline
		$D_{shore}(t)$ & km & distance between the narwhal and the nearest point on the shore at time $t$ & $\R^+$ \\
		\hline
		$E_{shore}(t)=\frac{1}{D_{shore}(t)} \1_{D_{shore}(t)<D_0}$ & $km^{-1}$ & global exposure level of the narwhal to the shore at time $t$ & $\R^+$ \\
		\hline
		$\Theta(t)$ & rad & angle between the vector that goes from the nearest shore point to the narwhal's position and the empirical step vector at time $t$  & $[-\pi,\pi]$ \\
		\hline 
	\end{tabular}
	\caption{Summary of the covariates}
	\label{tab: covariates}
\end{table}






\subsection{Mixed effet model for ship exposure and shore effects}
\label{subsection: ship exposure effect}


%WHY TENSOR SPLINES : because covariates THeta and Eshore are not on the same scale, and identity link function
% FOR TAU: this makes sense to use additive splines since the link function is log
To assess if the exposure to the ship has a significative effect on the narwhals movement, a baseline model is first fitted only on the data before exposure, to get an estimation on how the narwhals move when they are not exposed to the disturbance. Then, a response model is fitted on the data during exposure and check whether the estimated smooth parameters deviate significatively from the baseline values. We present here the baseline and response models.\\

For the baseline model, only the effect of the shore is included through the shore exposure covariate $E_{shore}$ and the angle covariate $\Theta$.\\
Although individuals have a tendency to move in the same way, their movement don't have exactly the same characteristics depending on their age and size for instance. This is taken into account by using a mixed effect model for the RCVM parameters.
For each narwhal $i \in \{1, \cdots, N\}$, write $t_{exp}^{(i)}$ the first time when it gets in line of sight with the ship (start of exposure). Then for $t \leq t_{exp}^{(i)}$, that is before exposure to the ship, the narwhals motion processes $V^{(i)}(t)=\begin{pmatrix} V^{(i)}_1(t) & V^{(i)}_2(t) \end{pmatrix}^\top$ and $X^{(i)}(t)=\begin{pmatrix} X^{(i)}_1(t) & X^{(i)}_2(t) \end{pmatrix}^\top$ are supposed to solve equation~\ref{eq: CRCVM equation}. Because $\tau$ and $\nu$ can only be positive, a log link function is used for these parameters. The angular velocity $\omega$ is expressed as a smooth function of $\Theta$ and $D_{shore}$ through splines. Since both covariates are not on the same scale (one is in $rad$ while the other is in $km$), tensor splines were judged more appropriate than thin plate regression splines \cite{wood_generalized_2017}.\\

Denoting $n_{i,pre}$ the number of observations before exposure for the narwhal $i$, $\tau^{(i)}$, $\nu^{(i)}$  and $\omega^{(i)}$ the parameters of the diffusion for this narwhal $i$ and  $\tau^{(i)}_j$, $\nu_j^{(i)}$, $\omega_j^{(i)}$ their values at time $t_j^{(i)}$ for $j \in \{1, \cdots,n_{i,pre}\}$,  the mixed effect model is written



\begin{equation} 
	\forall j \in \{1,\cdots, n_{i,pre}\},
	\left\{
	\begin{array}{l}
		
		\log(\tau^{(i)}_j)=\log(\tau_{pre})+b_{\tau,pre}^{(i)} \\
		\log(\nu^{(i)}_j)=\log(\nu_{pre})+b_{\nu,pre}^{(i)}  \\
		\omega^{(i)}_j=\omega_{0,pre}+\sum_{k=1}^{L} \omega_{k,pre} \psi_k(E_{shore}^{(i)}(t_j^{(i)}),\Theta^{(i)}(t_j^{(i)})) + b_{\omega,pre}^{(i)}
	\end{array}
	\right.
	\label{eq: approximate baseline model}
\end{equation}


$\log(\tau_{pre})$, $\log(\nu_{pre})$, $\omega_{0,pre}$ are population intercepts and $b^{(i)}_{pre}=\begin{pmatrix} b_{\tau,pre}^{(i)} & b_{\nu,pre}^{(i)} & b_{\omega,pre}^{(i)} \end{pmatrix}^\top \sim \mathcal{N}\left( 0, \diag\left(\frac{1}{\lambda_{pre}}\right)\right)$
are the individual parameters, where $\lambda_{pre}=\begin{pmatrix} \frac{1}{\sigma_{\tau,pre}^2} & \frac{1}{\sigma_{\nu,pre}^2} & \frac{1}{\sigma_{\omega,pre}^2} \end{pmatrix}^\top$ with variances $\sigma_{\tau,pre}^2$, $\sigma_{\nu,pre}^2$, $\sigma_{\omega,pre}^2$.

The $\psi_k$ in equation~\ref{eq: approximate baseline model} are  known bivariate cubic splines basis functions, constructed through tensor products from the univariate basis functions as described in \cite{wood_generalized_2017}, section 4.1.8.
%Add plot of the spline basis functions \\
$L=q_E \times q_{\Theta}$ and the numbers of knots in the splines is $q_E-1$ and $q_{\Theta}-1$ for the respective covariates $E_{shore}$ and $\Theta$. It is needed to choose them before hand. One possibility to help choosing the best value is to increase the degree of freedom step by step  and find the value for which the decrease in AIC starts to get lower. Equation \ref{eq: approximate baseline model} is based on the approximation that the covariates are constant on each time step $[t_j^{(i)},t_{j+1}^{(i)}]$, so that the parameters are piecewise constant, which allows to form a state-space model for estimation as described in section \ref{section: inference}.\\
In matrix form, equation~\ref{eq: approximate baseline model} can be written as
\begin{equation}
	\rho_{pre}= X_{pre} \beta_{pre}
	+Z_{pre}b_{pre}
\end{equation}

where $\rho_{pre}$ is the vector of the parameter values on each time step, that has size $3n=$ number of observations $\times$ number of parameters  \[\rho_{pre}=\begin{pmatrix}
	\log(\tau^{(1)}) & \cdots & \log(\tau^{(N)}) & \log(\nu^{(1)}) &
	\cdots & \log(\nu^{(N)}) & \omega^{(1)}  &\cdots & \omega^{(N)}
\end{pmatrix}^\top\]
with $	\log(\tau^{(i)})=\begin{pmatrix} \log(\tau^{(i)}_1) & \cdots \log(\tau^{(i)}_{n_i})\end{pmatrix}$ and similarly for the $\log(\nu^{(i)})$ and $\omega^{(i)}$.
$X_{pre}$ and $Z_{pre}$ are respectively the fixed and random effects model matrices with sizes $3n \times (L+3)$ and $3n \times 3N$. Expressions of these matrices are given in Appendix \ref{section: precisions about statistical models}.

$\beta_{pre}=\begin{pmatrix}
	\log(\tau_{pre}) &
	\log(\nu_{pre})  &
	\omega_{0,pre} &
	\omega_{1,pre} &
	\cdots & 
	\omega_{q_E q_{\Theta},pre}
\end{pmatrix}^\top$ is the vector of coefficients to estimate for the pre-exposure model and $b_{pre}=\begin{pmatrix}  b_{\tau,pre}^{(1)} &\cdots& b_{\tau,pre}^{(N)} &b_{\nu,pre}^{(1)}& \cdots & b_{\nu,pre}^{(N)} & b_{\omega,pre}^{(1)} & \cdots & b_{\omega,pre}^{(N)} \end{pmatrix}$ is the vector of random effects.\\

Then, the response model is designed to assess a deviation from the baseline model due to exposure to the ship. We illustrate this by addding a dependency on the covariate $E_{ship}$ in the parameters $\tau$ and $\nu$. 
For $i \in \{1, \cdots, N\}$, denote $n_{i,post}$ the number of post-exposure observations for the narwhal $i$.

\begin{equation} 
	\forall j \in \{1,\cdots, n_{i,post}\}, \quad 
	\left\{\begin{array}{l}
		
		\log(\tau^{(i)}_j)=\log(\tau_{0,post}) +\sum_{k=1}^{q_{\tau}} \log(\tau_{k,post})\phi_{k}(E_{ship}(t))+b^{(i)}_{\tau,post} \\
		\log(\nu^{(i)}_j)=\log(\nu_{0,post}) +  \sum_{k=1}^{q_{\nu}} \log(\nu_{k,post}) \xi_{k}(E_{ship}(t)) +b^{(i)}_{\nu,post}  \\
		\omega^{(i)}_j=\omega_{0,post}+\sum_{k=1}^{q_E\times q_{\Theta}} \omega_{k,post} \psi_k(D_{shore}(t),\Theta(t)) + b_{\omega,post}^{(i)}
	\end{array}
	\right.
	\label{eq: response model}
\end{equation}

Again, $\log(\tau_{0,post})$, $\log(\nu_{0,post})$, $\omega_{0,post}$ are unknown intercepts and $b^{(i)}_{post} \sim \mathcal{N}\left( 0, \diag\left(\frac{1}{\lambda_{post}}\right)\right)$ with $\lambda_{post}=\begin{pmatrix} \frac{1}{\sigma_{\tau,post}^2} & \frac{1}{\sigma_{\nu,post}^2} & \frac{1}{\sigma_{\omega,post}^2} \end{pmatrix}^\top$.$q_{\tau}$ and $q_{\nu}$ are the spline degrees of freedom for the exposure to the ship covariate.
We can write the mixed effect models in matrix form with the same notations as above.
\begin{equation}
	\rho_{post}
	=X_{post} \beta_{post}
	+Z_{post} b_{post}
\end{equation}

Estimation procedure for the vectors of coefficient $\beta_{pre}$, $\beta_{post}$ and the expected values of the random effects $b_{pre}$, $b_{post}$ given the observations are discussed in section~\ref{section: inference}.\\







\subsubsection{Maximum likelihood estimation}
The formulation of a state space model now allows for maximum likelihood estimation using Kalman filter.
We detail the maximum likelihood estimation for the response model in section~\ref{subsection: ship exposure effect}. \\

The spline coefficients in equation~\ref{eq: response model} will be treated as random effects to include a penalization in the log-likelihood. 
Introduce smoothing parameters $\lambda_{\tau}$,$\lambda_{\nu}$, $\lambda_{\omega,E}$ and $\lambda_{\omega,\Theta}$. The vectors of spline regression coefficients $\log(\tau_{post})$, $\log(\nu_{post})$, $\omega_{post}$,  conditioned on the smoothing parameter are supposed to follow independent multivariate normal distributions with means zero and respective precision matrices $\lambda_{\tau}S_{\tau}$, $\lambda_{\nu}S_{\nu}$ and $\lambda_{\omega,E}S_{\omega,E}+\lambda_{\omega,\Theta}S_{\omega,\Theta}$. $S_{\tau}$, $S_{\nu}$, $S_{\omega,E}$ and $S_{\omega,\Theta}$ are penalization matrices of known coefficients such that 
$\log(\tau_{post})^\top S_{\tau}\log(\tau_{post})$, $\log(\nu_{post})^\top S_{\nu}\log(\nu_{post})$, and $\omega_{post}^\top (S_{\omega,E}+S_{\omega,\Theta})\omega_{post}$ measure the wiggliness of the fitted splines \cite{michelot_varying-coefficient_2021,wood_generalized_2017}. Thus, the chosen prior favours smooth functions over wiggly ones. Now, the mixed effect model equation can be rewritten as $\rho_{post}=X_{post}\beta_{post}+Z_{post} b_{post}$ where the fixed effect coefficients are changed to $\beta_{post}=\begin{pmatrix} \log(\tau_{0,post}) & \log(\nu_{0,post}) & \omega_{0,post} \end{pmatrix} $ and the random effects to 
\[b_{post}=\begin{pmatrix} \log(\tau_{post}) & b_{\tau,post} & \log(\nu_{post}) & b_{\nu,post} & \omega_{post} & b_{\omega,post}\end{pmatrix}\]
The actual random effects $b_{\tau,post}$, $b_{\nu,post}$,$b_{\omega,post}$ also enter the same framework with a "penalization" matrix which is identity and smoothing parameters that are the inverse of the variances to be estimated.
All these smoothing parameters are gathered in a vector $\log(\lambda_{post})$ that is estimated from the data.
\\


Denote $y^{(i)}$,  $i \in \{1, \cdots, 6\}$, the observed track for the $i$-th narwhal after exposure, which consists in $n_i$ GPS positions.

The complete likelihood of the data and the random effects  is 

\begin{align*}
	L_c(\pmb{b_{post}},\beta_{post},\log(\lambda_{post}),\log(\sigma_{obs}))&= 
	\prod_{i=1}^{6} p\left(\pmb{b^{(i)}_{post}},\log(\tau_{post}),\log(\nu_{post}),\omega_{post} \vert \log(\lambda_{post})\right) \\
	&\times p\left(y^{(i)} \vert \pmb{b^{(i)}_{post}},\log(\tau_{post}),\log(\nu_{post}),\omega_{post},\beta_{post},\log(\lambda_{post}),\log(\sigma_{obs})\right)
	\label{eq: random effects likelihood}
\end{align*}

The terms $p\left(b^{(i)}_{post},  
\log(\tau_{post}),\log(\nu_{post}),\omega_{post}\vert \log(\lambda_{post})\right)$ can be computed since $b^{(i)}_{post}$, $\log(\tau_{post})$ and  $\log(\nu_{post})$ are independent and their distributions are known multivariate gaussians.\\

For each individual $i \in \{1,\cdots,6\}$, the distribution of the hidden state $\alpha^{(i)}_j=\begin{pmatrix} x^{(i)}_{j,1} & x^{(i)}_{j,2} & v^{(i)}_{j,1} & v^{(i)}_{j,2}\end{pmatrix}^\top$ conditioned on previous observations and random effects, i.e $\alpha_j^{(i)} \vert (y^{(i)}_{1:j-1},b_{post}^{(i)},\log(\tau_{post}),\log(\nu_{post}),\omega_{post})$, is $\mathcal{N}(\alpha_j^{(i)-}, R_j^{(i)-})$ where the matrices $\alpha_j^{(i)-}$ and $R_j^{(i)-}$ are computed by the Kalman filter with parameter values according to the conditioned values of the random effects and the equation~\ref{eq: response model}.
Hence
\begin{equation} y_j^{(i)} \vert (y_{1:j-1}^{(i)}, b_{pre}^{(i)}) \sim \mathcal{N} \left( Z \alpha_j^{(i)-},Z R_j^{(i)-} Z^\top+\sigma_{obs}^2 I_2 \right)
	\label{eq: ditribution of observations conditioned on random effects}
\end{equation}
and the density $p\left(y^{(i)} \vert \pmb{b^{(i)}_{post}},\log(\tau_{post}),\log(\nu_{post}),\omega_{post},\beta_{post},\log(\lambda),\log(\sigma_{obs})\right)$ is deduced from this result.


Let $\mathcal{L}_c(\pmb{b_{post}},\beta_{post},\log(\lambda_{post}),\log(\sigma_{obs});y)= - \log( L_c(\pmb{b_{post}},\beta_{post},\log(\lambda_{post}),\log(\sigma_{obs})))$ be the joint negative log-likelihood of the data and the random effects. 
Then the likelihood of the data is the integral 
\[
L(\beta_{post},\log(\lambda_{post}),\log(\sigma_{obs});y)=\int_{\mathbb{R}^{d}} \exp(-\mathcal{L}_c(\pmb{b_{post}},\theta_{pre},\log(\lambda_{pre}),\log(\sigma_{obs});y) )d\pmb{b_{post}}
\]
where in this specific case, $d=3N+q_{\tau}+q_{\nu}+L$.


The package \texttt{smooothSDE} relies on the package \texttt{TMB} to optimize this likelihood and get estimations of the coefficients.
Laplace's approximation consists in finding a minimum of the function $\mathcal{L}_c$ with respect to $b_{post}$ and then approximating the integral over this parameter by the integral of a gaussian curve.
This approximation is then optimized over $\beta_{post}$, $\log(\lambda_{post})$ and $\log(\sigma_{obs})$ using gradient methods and auto-differentiation \cite{kristensen_tmb_2016}. More precisely, optimization is  performed by using the usual \texttt{optim} R function, and plugging in the gradient function calculated by \texttt{TMB} via automatic differentiation. The BFGS method (Broyden–Fletcher–Goldfarb–Shanno algorithm) is generally used for non linear unconstrained problems. If we set constraints on the SDE parameter (maximum values of $\tau$ and $\nu$) based on biological expertise for instance, then Limited Memory BFGS with box constraints method should be preferred. In this study, BFGS method was used.\\
Results of the optimization are estimated parameters intercepts $\hat{\beta}_{post}$, estimated smooothing parameters $\log(\hat{\lambda}_{post})$, estimated modes $\hat{b}_{post}^{(i)}$ of the random effects, and possibly estimated log of the standard deviation $\log(\hat{\sigma}_{obs})$ for the measurement error.
Uncertainties on the estimates are derived from the inverse of the hessian matrix of the negative log-likelihood at estimated values and the delta method \cite{kristensen_tmb_2016}.

%Talk about the consistency and asymptotic properties of such estimators


%conditions on the shore (regularity) and time steps
%discuss conditions on omega and tau, existence of solution e

\section{Estimation of ship exposure effect on real narwhal data}

A baseline model is fitted on the narwhals's track before exposure. It is supposed to capture the characteristics of the movement under normal conditions. Deviation from the baseline is then assessed by fitting a model with covariates $E$ on the tracks during exposure.

\subsection{Estimation without constraints}

First, a simple CVM (see equation \ref{eq: CVM equation}) was used to assess any behavioural response of the narwhals to the ship exposure.

\subsubsection{Baseline estimations}
Due to the low variability of the estimates of $\tau$ for each individual, it was chosen to only estimate one intercept value for this parameter. It was estimated to $\hat{\tau}_{pre}=0.90 $ km/h with $95 \%$ of its values comprised between $0.85$ and $1.1$ h.
In comparison, harbour seal in Alaska were proved to exhibit slightly more persistent motion $\hat{\tau}=1.51$ h with $95\%$ CI ; $1.30 -1.75$  \cite{johnson_continuous_2008} while bowhead whales in Greenland showed much less persistence $\hat{\tau}=0.17$ h with $95\%$ CI ; $0.14 -0.20$  \cite{gurarie_correlated_2017}.
The intercept value for $\nu$ was estimated to be $\hat{\nu}_{pre}=4.19$ km/h with $95\%$ CI $3.79-4.63$.
The estimates for the long term velocity $\mu$ show that all the narwhals have a tendency to move toward the south ($\mu_2<0$) with more individual variability for the east-west direction $\mu_1$. However, confidence intervals are large and  forcin $\mu$ to $(0,0)$ is also a reasonable choice.

\begin{figure}[H]
    \centering
  
    \begin{subfigure}{0.49\textwidth}
    \includegraphics[scale=0.3]{images/unconstrained_models/baseline/re_baseline2_mu1.png}
    \caption{Estimated $\mu_1$ (km/h) for the baseline model}
    \label{fig: re_baseline1_mu1}
    \end{subfigure}
     \begin{subfigure}{0.49\textwidth}
    \includegraphics[scale=0.3]{images/unconstrained_models/baseline/re_baseline2_mu2.png}
    \caption{Estimated $\mu_2$ (km/h) for the baseline model}
    \label{fig: re_baseline1_mu2}
    \end{subfigure}
  	\begin{subfigure}{0.49\textwidth}
	\includegraphics[scale=0.3]{images/unconstrained_models/baseline/re_baseline2_nu.png}
	\caption{Estimated $\nu$ (km/h)for the baseline model}
	\label{fig: re_baseline1_tau}
	\end{subfigure}
    \caption{Estimated parameters for each individual in the baseline model : the y axis are the estimated parameters along with $95 \%$ confidence interval and the x-axis represents the narwhals's ID.}
    \label{fig: constraints free baseline estimates}
\end{figure}

The estimated values for $\nu$ are all close to $4$ km/h with slight variations among individuals. This value should not be come as a surprise since the mean value of the horizontal velocity norm in the data is $4.4$ km/h, and it is known  that once the velocity process has reached stationarity (typically after $3\tau$), its norm follows a Rice distribution, whose mean is close to $\nu$ when $\vert\vert\mu\vert \vert$ is 
close to $0$.\\

The response model after exposure will be compared to this baseline model to assess any external effect on the narwhals's movement. Examining deviations from this baseline only makes sense when the model is reliable and describes well the narwhals's movement under normal conditions.
To check the goodness of fit of the baseline model, two statistics are computed from the observed tracks of each narwhal : mean velocity norm and the mean velocity phase. For the $i$-th narwhal, the mean velocity norm and phase are approximated as
\[\tilde{v}^{(i)}=\frac{1}{n_i-1}\sum_{j=1}^{n_i-1}  \tilde{v}^{(i)}_j \quad \tilde{\phi}^{(i)}=\frac{1}{n_i-1} \sum_{j=1}^{n_i-1} \widehat{(v_j^{(i)},e)} \mbox{ where } e=(1,0)\]
where $\tilde{v}^{(i)}_j=\frac{y_{j+1}^{(i)}-y^{(i)}_j}{\Delta^{(i)}_j}$, $n_i$ is the number of measurements, $y^{(i)}_j$ is the GPS position of the narwhal $i$ at time $t_j^{(i)}$ and $\Delta^{(i)}_j=t^{(i)}_{j+1}-t^{(i)}_j$.\\
Then the intercepts and modes of the random effects of the fitted baseline model are sampled 500 times from the posterior distribution using the joint covariance matrix produced by the optimization of the likelihood. Draws of the parameters of the SDE are deduced from the sampled coefficients and one trajectory is simulated for each narwhal according to the sampled parameters. For each simulated trajectory, mean of the norm and the phase of the velocity are estimated. This produces an histogram for each statistic (norm and phase) and each narwhal. If sampled tracks have enough similarities with the observed tracks, then the observed statistics should appear near the middle of the histograms. This checking procedure was introduced in \cite{michelot_continuous-time_2022}. Figures~\ref{fig: baseline velocity norm posterior check} and~\ref{fig: baseline velocity phase posterior check} show respectively the histograms of the mean velocity norm and the mean velocity phase.

 \begin{figure}[H]
    \centering
    \includegraphics[scale=0.6]{images/unconstrained_models/baseline/check_mean_vnorm_baseline2.png}
    \caption{Histogram of the mean velocity computed from trajectories of the fitted model for each narwhal, along with observed values in red.}
    \label{fig: baseline velocity norm posterior check}
\end{figure}

 \begin{figure}[H]
    \centering
    \includegraphics[scale=0.6]{images/unconstrained_models/baseline/check_mean_phase_baseline2.png}
    \caption{Histogram of the phase angle of the velocity computed from trajectories of the fitted model for each narwhal, along with observed values in red.}
    \label{fig: baseline velocity phase posterior check}
\end{figure}


The fitted baseline model seems to capture well the mean velocity norm and phase of the observed data for the majority of the narwhals. However, attention should be drawn on the phase angle histogram for the narwhal A6, which reveals a mismatch between the model and the observed phase angle. Narwhal A6 is likely to be heading in the south direction (mean phase angle close to $-\frac{\pi}{2})$. 


\subsubsection{Response estimations}


Once the baseline model is deemed satisfactory, a response model is fitted on the tracks during exposure. We computed the marginal and conditional AIC values with different number of knotrs for the spline estimation of the parameters $\tau$ and $\nu$. The marginal AIC is defined in \cite{wood_generalized_2017} as $- 2L + 2k$ where L is the maximum marginal log-likelihood (of fixed effects), and $k$ is the number of degrees of freedom of the fixed effect component of the model. The conditional AIC also defined in \cite{wood_generalized_2017} is $- 2L' + 2k'$ where $L'$ is the maximum joint log-likelihood (of fixed and random effects), and $k'$ is the number of effective degrees of freedom of the model. Note that  the effective degree of freedom is not properly a number of degrees of freedom, but rather a measure of the flexibility or complexity of the model %detail how AIC is computed (wood); based on the trace of the Hessian matrix of the negative log likelihood.
%Intuition for the effective degreed of freedom
%Tendency to favour more complex model when the true model is not in the set of models tested

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.45]{images/unconstrained_models/response/plotAIC3.png}
	\caption{}
	\label{fig: plotAIC3}
\end{figure}

After $q=7$, the decrease in the marginal AIC curve seems to be lower than it was before. This suggests to choose $q-1=6$ knots for the estimation of the parameters with cubic spline. Note that choosing $q$ a bit lower or higher does not change dramatically the estimated smooth functions.
Figure~\ref{fig: fe_response3_tau_ExpShip} shows the estimated fixed effects of the covariate $E$ for the parameter $\tau$. Figure~\ref{fig: fe_response3_nu_ExpShip} shows the same plot but for the smooth parameter $\nu$. The variable on the x-axis is the distance to the shore, that is the inverse of $E$. 


\begin{figure}[H]
    \centering
    \includegraphics[scale=0.45]{images/unconstrained_models/response/fe_response3_tau_ExpShip.png}
    \caption{Estimation of the fixed effects for $\tau$ with 95\% pointwise confidence interval. The red curve is the estimated function, the dotted line is the intercept estimated in the baseline with its 95\% confidence interval in light grey.}
    \label{fig: fe_response3_tau_ExpShip}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.45]{images/unconstrained_models/response/fe_response3_nu_ExpShip.png}
	\caption{Estimation of the fixed effects for $\nu$ with 95\% pointwise confidence interval. The red curve is the estimated function, the dotted line is the intercept estimated in the baseline with its 95\% confidence interval in light grey.}
	\label{fig: fe_response3_nu_ExpShip}
\end{figure}

Deviations from undisturbed behaviour coincide with intervals on the x-axis where the confidence intervals of the baseline estimate and the response estimate are disjoint. 
This happens for the parameter $\nu$ when the narwhals are highly exposed to the ship, more precisely when they are at a distance to the ship lower than $8$ km. In this case, $\nu$ is significantly higher than the baseline value, proving that narwhals tend to move faster when highly exposed to the ship noise. Again, this should not come as a surprise since, for instance, the mean experimental velocity norm when the narwhals are less than $5$ km away from the ship is $5.7$ km/h, which is more than $1$ km/h higher than the mean experimental velocity norm before exposure. 
This also shows that the random component in the velocity equation has more importance when the narwhals are highly exposed to the ship, and can be interpreted as more variability in the narwhals horizontal velocity.
Regarding the persistence parameter, it is significantly lower than average in two cases. First, when the narwhals are very close to the ship (distance $<3.5$ km), it can be up to third times less persistent than usual. Then, up to $25$ km away from the ship, no significant deviation from the baseline value can be ascertained. However, more than $25$ km away from the ship, it can still be detected that the narwhals persistence is a bit lower than the baseline value (around $0.6$ instead of $0.9$). This decrease in persistence reveals that the animals gets generally agitated and have a tendency to change their heading more frequently when the military ship is sailing in the fjords.\\

Narwhals position relative to the ship were considered :
\begin{itemize}
	\item very close when the distance to the ship was lower than the $5\%$. quantile, which is $4.04$ km.
	\item close when the distance to the ship was lower than the $25\%$ quantile, which is $9.35$ km.
	\item medium when the distance to the ship was between the $25\%$ and $75\%$ quantile, that is between $9.35$ and $25.80$ km.
	\item far otherwise.
\end{itemize}
\begin{table}[H]
	\centering
\begin{tabular}{|c|c|c|c|c|}
	\hline
	Position relative to the coast & mean $\hat{\tau}$  & mean $\hat{\nu}$ & $\frac{\hat{\tau}-\hat{\tau}_{pre}}{\tau_{pre}}$ & $\frac{\hat{\nu}-\hat{\nu}_{pre}}{\hat{\nu}_{pre}}$   \\
	\hline
	Very close & 0.50 & 6.1 & $-44 \%$ & $+45 \%$ \\
	\hline
	Close & 0.88 & 5.3 & not significaant & $+26\%$ \\
	\hline
	Medium&  1.01 &  4.6 &  not significant & not significant \\
	\hline
	Far &  0.60 & 4.3 & $-33\%$ & not significant \\
	\hline
\end{tabular}
\caption{Comparison of response and baseline values of the parameters for different levels of exposure to the ship}
\label{table: baseline vs response parameters comparison}
\end{table}

\textcolor{red}{ADD POSTERIOR PREDICTIVE CHECKS}

\subsection{Estimation with constraints}



\subsubsection{Baseline estimations}

The effect of the shore was included directly in the baseline model through bivariate splines of the Distance to the shore and the angle $\Theta$.
The mean velocity $\mu$ was fixed to $(0,0)$ and $\omega$ was estimated as smooth functions of $D_{shore}$ and $\Theta$.


\textcolor{red}{More details about tensor splines estimations can be found in chapter 4 of \cite{wood_generalized_2017}.}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{images/constrained_models/omega_estimations}
	\caption{Estimation of smooth parameter $\omega$ with tensor splines}
	\label{fig:omegaestimations}
\end{figure}



\subsubsection{Response estimations}

\section{Discussion}



As discussed in \cite{ditlevsen_hypoelliptic_2019}, estimation for such hypoelliptic models is challenging. The main difficulties come from
\begin{itemize}
	\item degenerate noise structure that prevents the use of standard approximation schemes as Euler-Maruyama.
	\item irregular times of observations : we only get position when the marine mammal reaches the sea surface.
	\item GPS measurement errors, with gaussian or student distribution.
	\item partial observations : two processes are involved in equation~\ref{eq: RACVM equation}, however only one of them is observed, that is the position.
\end{itemize}
Several method already exist to estimate the parameters $\tau$, $\nu$, $\mu$ and $\omega$.
If the parameters are constant, it is possible to use a method of moments based on the distributional results about the velocity process \cite{gurarie_correlated_2017}, but it is only feasible with high frequency data and negligible measurement errors. Maximum likelihood with Kalman filter allows to estimate more efficiently from observations with errors \cite{johnson_continuoustime_2008}.
If the parameters are allowed to depend on time through external covariates, then \texttt{smoothSDE} package, which is based on \cite{johnson_continuoustime_2008} but exploit the capabilities of both the \texttt{mgcv} package \cite{wood_generalized_2017} to specify the time dependency through covariates, and the \texttt{TMB} \cite{kristensen_tmb_2016} package to integrate over the random effect and optimize the likelihood, is a convenient tool for estimation. \\


For the narwhals, a tendency to move along the shore could be considered by specifying a function $\omega$ that is non zero even when $\Theta \in \left[\frac{\pi}{2}-\varepsilon,\frac{\pi}{2}\right] \cup \left[-\frac{\pi}{2},-\frac{\pi}{2}+\varepsilon\right]$, so that when the animal would be on the verge of leaving the shore, its velocity would be tweaked to align with the shoreline. It is also possible  to specify $\tau$ similarly as a function of $D_{shore}$ and $\Theta$ to model specific behaviour near the shore (e.g higher persistence along the shoreline).

\newpage

\printbibliography

\newpage 

\appendix

\section{More details about the data}


\begin{table}[H]
	\centering
	\begin{tabular}{|c|c|c|}
		\hline
		Narwhal ID & Number of measurement before exposure & Number of measurements during exposure \\
		\hline
		A1 & 258 & 576\\
		\hline
		A2  & 40 & 515 \\
		\hline
		A3 & 222 & 680 \\
		\hline
		A4 & 291 & 642  \\
		\hline
		A5 & 48 & 419\\
		\hline
		A6 & 76 & 425 \\
		\hline
		\textbf{Total} & \textbf{935} & \textbf{3257} \\
		\hline
	\end{tabular}
	\caption{Distribution of the data among the 6 individuals}
	\label{table: data distribution}
\end{table}

\begin{figure}[H]
	\centering
	\begin{subfigure}{0.49\textwidth}
		\centering
		\includegraphics[scale=0.38]{images/data_exploration/all_tracksBE.png}
		\caption{Tracks before exposure experiments}
	\end{subfigure}
	\begin{subfigure}{0.49\textwidth}
		\centering
		\includegraphics[scale=0.38]{images/data_exploration/all_tracksAE.png}
		\caption{Tracks during exposure experiments}
	\end{subfigure}
	\caption{Movement data of East Greenland narwhals}
	\label{fig: tracks before and after exposure}
\end{figure}


\section{Detailed computations of the integrated rotational Ornstein-Uhlenbeck model}
\label{section: detailed RACVM computations}

\subsection{Velocity process}

\subsubsection{Solution to the SDE}

\begin{equation}
	v(t)=\exp(-At) v(0)+ (I_2-\exp(-At))\mu +\frac{2\nu}{\sqrt{\pi \tau}}\int_{0}^{t} \exp(A(s-t)) dW(s)
	\label{eq: RACVM solution}
\end{equation}
In the sequel, we shall use the notation 
\[\zeta(0,t) =\frac{2\nu}{\sqrt{\pi \tau}}\int_{0}^{t} \exp(A(s-t)) dW(s)\] 

Replacing $\exp(At)$ by its expression gives more explicitly
\begin{equation}
	v_1(t)=e^{-\frac{t}{\tau}} \left(\cos(\omega t)v_1(0)+\sin(\omega t)v_2(0)\right)+(1-e^{-\frac{t}{\tau}}\cos(\omega t))\mu_1-e^{-\frac{t}{\tau}} \sin(\omega t) \mu_2 +\zeta_1(0,t)
	\label{eq: first random component RACVM}
\end{equation}


\begin{equation}
	v_2(t)=e^{-\frac{t}{\tau}} \left(-\sin(\omega t)v_1(0)+\cos(\omega t)v_2(0)\right)+e^{-\frac{t}{\tau}} \sin(\omega t) \mu_1+(1-e^{-\frac{t}{\tau}}\cos(\omega t))\mu_2 +\zeta_2(0,t)
	\label{eq: second random component RACVM}
\end{equation}
where \begin{align*}
	\zeta_1(0,t)&=\frac{2\nu}{\sqrt{\pi \tau}} \int_0^t e^{\frac{s-t}{\tau}} \cos(\omega(s-t)) dW_1(s) -\frac{2\nu}{\sqrt{\pi \tau}} \int_0^t e^{\frac{s-t}{\tau}} \sin(\omega(s-t)) dW_2(s) \\
	\zeta_2(0,t)&=\frac{2\nu}{\sqrt{\pi \tau}} \int_0^t e^{\frac{s-t}{\tau}} \sin(\omega(s-t)) dW_1(s) +\frac{2\nu}{\sqrt{\pi \tau}} \int_0^t e^{\frac{s-t}{\tau}} \cos(\omega(s-t)) dW_2(s)
\end{align*}
\subsubsection{Autoregressive equation}

For $t \geq 0$ and $\Delta >0$, 

\[v(t+\Delta) \vert v(t) \sim \mathcal{N}\left( \mu + \exp(-A\Delta)(v(t)-\mu), \frac{2\nu^2}{\pi}(1-e^{-2\frac{\Delta}{\tau}}) I_2 \right) \]

Intuitively, the next velocity has a mean that is the sum of the long term mean velocity $\mu$ and the deviation of the previous velocity from this long term mean rotated by an angle $\omega \Delta$.
\subsubsection{Stationary distribution}

If $v(0) \sim \mathcal{N}\left(\mu,\frac{2\nu^2}{\pi} I_2\right)$ then for all $t \geq 0$, $v(t) \sim \mathcal{N}\left(\mu,\frac{2\nu^2}{\pi} I_2\right)$

\subsubsection{Distribution of the velocity norm and phase}
 The order of magnitude of the parameter $\nu$ is similar to the overall mean empirical velocity norm. The distribution of the phase angle $\Phi$ of the velocity is derived in \cite{pawula_distribution_1982}.
When $\mu=0$, this distribution is uniform over $[-\pi,\pi]$. Hence, taking a look at the histograms of the phase angle of the data can help to assess whether a non zero mean velocity is necessary in the model or not.

Suppose that $t\geq \frac{3}{\beta}$ so that the velocity has reached its stationary distribution
\begin{align*}
	&v_1(t) \sim \mathcal{N}\left(\mu_1, \frac{2\nu^2}{\pi}\right) \\
	&v_2(t) \sim \mathcal{N}\left(\mu_2, \frac{2\nu^2}{\pi}\right)
\end{align*}

\begin{figure}[H]
	\centering
	\begin{tikzpicture}
		% Draw axes
		\draw[->] (-1,0) -- (5,0) node[right] {$x$};
		\draw[->] (0,-1) -- (0,5) node[above] {$y$};
		
		% Draw point at (3,4) with circle
		\fill (3,4) circle (2pt);
		\draw[blue,dashed] (3,4) circle (1.5);
		
		%Draw vectors
		\draw[->,dotted,red] (-0,0) -- (3.5,3.5) node[right] {$v(t)$};
		\draw[->,dotted,red] (0,0) -- (2.6,4.2) node[above] {$v(t')$};
		% Add node with text $\mu$
		\node at (3,4) [above right] {$\mu$};
		
		% Add node beside the circle with text $\frac{\sigma^2}{2\beta}$
		\node[blue] at (4.5,3) [anchor=west] {$\frac{\sigma^2}{2\beta}$};
	\end{tikzpicture}
\end{figure}
Thus, $ \vert \vert v(t) \vert \vert$ follows a \href{https://en.wikipedia.org/wiki/Rice_distribution}{Rice distribution} with mean parameter $\vert \vert \mu \vert \vert$ and variance parameter $\frac{2\nu^2}{\pi}$. Its probability density function is thus defined by
\[\forall x \geq 0, \quad f(x)= \frac{\pi}{2\nu^2}x \exp\left(-\frac{\pi (x^2+ \vert \vert \mu \vert \vert^2)}{4\nu^2}\right) I_{0}\left(   \frac{\pi}{2\nu^2}\times \vert \vert \mu \vert \vert x \right)\]
where $I_0$ is a modified Besssel function of the first kind defined such that 
\[\forall y  \in \R, \quad I_0(y)=\sum_{m=0}^{+\infty} \frac{1}{m!^2}\left(\frac{y}{2}\right)^{2m}\]
Its moments can be expressed with
\[\E\left(\vert \vert v(t) \vert \vert\right)=\sqrt{\frac{2}{\pi}}\nu \times \sqrt{\frac{\pi}{2}} L_{\frac{1}{2}} \left( -\frac{\beta}{\sigma^2} \vert \vert \mu \vert \vert ^2 \right)\]

Here, $L_{\frac{1}{2}}(x)=e^{\frac{x}{2}} \left( (1-x) I_0\left( -\frac{x}{2}\right)-xI_1\left( -\frac{x}{2}\right)\right)$ with $I_1(y)=\sum_{m=0}^{+\infty} \frac{1}{m!(m+1)!}\left(\frac{y}{2}\right)^{2m+1}$.\\

In the case $\mu=(0,0)$, the mean velocity norm is simply 
\[\E(\vert \vert v(t) \vert \vert)=\nu L_{\frac{1}{2}}(0)=\nu I_{0}(0)=\nu\]


Then, in the plane, $v(t)$ can be thought of as a complex random variable $v(t)=v_1(t)+iv_2(t)$ that has complex normal distribution with mean $\mu_1+i\mu_2$, variance $\E\left((v(t)-\E(v(t)))\overline{(v(t)-\E(v(t)))}\right)=\frac{4\nu^
	2}{\pi}$ and pseudo-variance $\E\left((v(t)-\E(v(t)))^2\right)=0$. Thus, $v(t)$ has a circular symmetric normal distribution with mean $\mu_1+i\mu_2=\vert \vert \mu \vert \vert e^{i\theta}$ where $\theta=\arctan(\mu_2,\mu_1) \in [-\pi, \pi]$ and variance $\frac{\sigma^2}{\beta}$.
Denote $\Phi=\arctan(v_2(t),v_1(t)) \in [-\pi, \pi]$ the phase angle of $v(t)$.
According to \cite{letzepis_vonmises_2015,bennett_solving_1956}, the distribution of $\Phi$ is 
\[\forall \phi \in [-\pi,\pi], \quad f_{\Phi}(\phi)=\frac{e^{-\frac{\beta \vert \vert \mu \vert \vert^2}{2\sigma^2}}}{2\pi} +\frac{\sqrt{\beta} \vert \vert \mu \vert \vert}{2\sigma\sqrt{2\pi}} \cos(\phi-\theta)e^{-\frac{\beta\vert \vert \mu \vert \vert^2 \sin^2(\phi-\theta)}{2\sigma^2}} \times \left(1+\erf\left(\frac{\beta^{\frac{1}{4}}\vert \vert \mu \vert \vert \cos(\phi-\theta)}{\sqrt{2\sigma}}\right)\right)\]
where $\erf$ is the Gauss error function defined by 
\[\forall z \in \R, \quad \erf(z)=\frac{2}{\sqrt{\pi}} \int_0^z e^{-t^2} dt\]
When $\mu=0$, this simplifies to a uniform distribution over $[-\pi,\pi]$.\\
%plot of the function for non zero mu

\subsubsection{Velocity autocovariance function}

Suppose that $v(0)$ has the stationary distribution.The autocovariance function is the expected dot product of the velocity vectors over different lags.

\[\mathbb{E}(\langle v(t), v(t+\Delta) \rangle =Cov(v_1(t)v_1(t+\Delta))+Cov(v_2(t),v_2(t+\Delta))+\mathbb{E}(v_1(t)) \mathbb{E}(v_1(t+\Delta))+\mathbb{E}(v_2(t)) \mathbb{E}(v_2(t+\Delta))\]

Therefore, the velocity autocovariance function is 

\begin{equation}
	\mathbb{E}(\langle v(t), v(t+\Delta) \rangle )=\frac{4\nu^2}{\pi} \cos(\omega \Delta) e^{-\frac{\Delta}{\tau}}+\vert \vert \mu \vert \vert^2
	\label{eq: RACVM autocovariance function}
\end{equation}

\subsection{Location process} \label{RACVM location process}
For $t \geq 0$ and $\Delta >0$,

\begin{align*}
	x(t+\Delta)&=x(t)+\int_t^{t+\Delta} v(s) ds \mbox{ where } v(s)=\mu+\exp(-A(s-t))(v(t)-\mu)+\zeta(t,s) \\
	&= x(t)+\mu \Delta+\int_t^{t+\Delta} \exp(-A(s-t))(v(t)-\mu) ds +\int_t^{t+\Delta} \zeta(t,s) ds \\
	&= x(t)+\mu \Delta +\int_0^{\Delta} \exp(-As)(v(t)-\mu) ds +\int_t^{t+\Delta} \zeta(t,s) ds \\
	&=x(t)+\mu \Delta + (A^{-1}(v(t)-\mu)-A^{-1}\exp(-A\Delta)(v(t)-\mu))+\int_t^{t+\Delta} \zeta(t,s) ds \\
\end{align*}
Thus, 
\begin{equation}
	x(t+\Delta)=x(t)+\mu \Delta+A^{-1} \left( I_2-\exp(-A\Delta)\right)(v(t)-\mu) +\xi(t,t+\Delta) \\
	\mbox{ where } \xi(t,t+\Delta)=\int_t^{t+\Delta} \zeta(t,s)ds
\end{equation}
Note that when $\Delta \rightarrow 0$, the deterministic part tends to $x(t)+\Delta v(t)$ as one would expect frome the Euler Maruyama scheme.
It is known that $\xi$ is normally distributed with mean zero. We still have to compute its covariance matrix.

\begin{align*}
	\int_t^{t+\Delta} \zeta(t,s) ds &=\int_t^{t+÷\Delta} \frac{2 \nu}{\sqrt{\pi \tau}} \left( \int_t^s \exp(-A((u-s))dW(u) \right) ds \\
	&=\frac{2\nu}{\sqrt{\pi\tau}} \int_t^{t+\Delta} \left( \int_u^{t+\Delta} \exp(A(u-s)) ds \right) dW(u)  \\
	&= \frac{2\nu}{\sqrt{\pi \tau}} \int_t^{t+\Delta} (A^{-1}-A^{-1}\exp(A(u-t-\Delta))) dW(u) \\
	&= \frac{2\nu}{\sqrt{\pi \tau}} \int_t^{t+\Delta} A^{-1}(I_2-\exp(A(u-t-\Delta))) dW(u)
\end{align*}
From this formula we deduce an expression for both components $\xi_1(t,t+\Delta)$ and $\xi_2(t,t+\Delta)$ of the gaussian vector.
\begin{align*}
	\begin{pmatrix}
		\xi_1(t,t+\Delta) \\ \xi_2(t,t+\Delta) 
	\end{pmatrix}
	&=\frac{2\nu}{\sqrt{\pi \tau}} \int_t^{t+\Delta} \frac{1}{\frac{1}{\tau^2}+\omega^2} 
	\begin{pmatrix}
		\frac{1}{\tau} & \omega \\ -\omega & \frac{1}{\tau}
	\end{pmatrix} \times \\
	& \left[ \begin{pmatrix} 1 & 0 \\ 0 & 1 \end{pmatrix}-\exp\left( -\frac{t+\Delta -u}{\tau}\right) 
	\begin{pmatrix} \cos(\omega(t+\Delta-u)) & \sin(\omega(t+\Delta-u)) \\
		-\sin(\omega(t+\Delta-u)) & \cos(\omega(t+\delta-u)) 
	\end{pmatrix} \right]
	\begin{pmatrix}
		dW_1(u) \\ dW_2(u)
	\end{pmatrix}\\
	&= \frac{2\nu}{\sqrt{\pi \tau} \times \left( \frac{1}{\tau^2}+\omega^2\right)} \int_t ^{t+\Delta} \begin{pmatrix} \frac{1}{\tau} & \omega \\ -\omega & \frac{1}{\tau} \end{pmatrix} \times \\
	&\begin{pmatrix}  1-\exp\left(-\frac{(
			t+\Delta-u}{\tau} \right) \cos(\omega(t+\Delta-u)) & -\exp\left( -\frac{t+\Delta-u}{\tau}]\right) \sin(\omega(t+\Delta-u)) \\
		\exp \left( -\frac{t+\Delta-u}{\tau}\right) \sin(\omega(t+\Delta-u)) & 1-\exp\left( -\frac{t+\Delta-u}{\tau}\right) \cos(\omega(t+\Delta-u))\end{pmatrix}
	\times \begin{pmatrix} 
		dW_1(u) \\ dW_2(u)
	\end{pmatrix} \\
	&= \frac{2\nu}{\sqrt{\pi \tau} \times \left( \frac{1}{\tau^2}+\omega^2\right)} \int_t ^{t+\Delta} \begin{pmatrix} \frac{1}{\tau} & \omega \\ -\omega & \frac{1}{\tau} \end{pmatrix} \times \\
	& \begin{pmatrix} \left(1-\exp\left( -\frac{t+\Delta-u}{\tau}\right)\cos(\omega(t+\Delta-u))\right) dW_1(u)-\exp\left(  -\frac{t+\Delta-u}{\tau} \right) \sin(\omega(t+\Delta-u))dW_2(u) \\
		\exp\left(  -\frac{t+\Delta-u}{\tau} \right) \sin(\omega(t+\Delta-u))dW_1(u)+\left(1- \exp\left( -\frac{t+\Delta-u}{\tau}\right)\cos(\omega(t+\Delta-u))\right)dW_2(u)
	\end{pmatrix}
\end{align*}

Eventually, 
\begin{align*}
	\xi_1(t,t+\Delta)&=\frac{2\nu}{\sqrt{\pi \tau} \times \left( \frac{1}{\tau^2}+\omega^2\right)} \times \frac{1}{\tau} \times \Bigg( \textcolor{red}{\int_t^{t+\Delta} \left( 1-\exp\left(-\frac{t+\Delta-u}{\tau}\right)\cos(\omega(t+\Delta-u))\right)dW_1(u)}\\
	&-\textcolor{blue}{\int_t^{t+\Delta} \exp\left( -\frac{t+\Delta-u}{\tau}\right) \sin(\omega(t+\Delta-u))dW_2(u)}\Bigg) \\
	&+\frac{2\nu}{\sqrt{\pi \tau} \times \left( \frac{1}{\tau^2}+\omega^2\right)}  \times \omega \Bigg( \textcolor{red}{\int_t^{t+\Delta} \exp\left( -\frac{t+\Delta-u}{\tau}\right) \sin(\omega(t+\Delta-u))dW_1(u)}+ \\
	& \textcolor{blue}{\int_t^{t+\Delta} \left( 1-\exp\left(-\frac{t+\Delta-u}{\tau}\right)\cos(\omega(t+\Delta-u))\right)dW_2(u)}\Bigg)
\end{align*}

\begin{align*}
	\xi_1(t,t+\Delta)&=\frac{2\nu}{\sqrt{\pi \tau} \times \left( \frac{1}{\tau^2}+\omega^2\right)}  \times  \Bigg( \textcolor{red}{\int_t^{t+\Delta} \bigg( \frac{1}{\tau} \left(1-\exp\left( -\frac{t+\Delta-u}{\tau}\right) \cos(\omega(t+\Delta-u))\right)}  \\
	& \textcolor{red}{+\omega \exp \left( -\frac{t+\Delta-u}{\tau}\right) \sin(\omega(t+\Delta-u))\bigg)dW_1(u)} \\
	&\textcolor{blue}{+\int_t^{t+\Delta} \bigg( \omega \left(1-\exp\left( -\frac{t+\Delta-u}{\tau}\right) \cos(\omega(t+\Delta_u))\right)} \\
	&\textcolor{blue}{-\frac{1}{\tau} \exp\left(-\frac{t+\Delta-u}{\tau} \right) \sin(\omega(t+\Delta-u)) \bigg) dW_2(u)} \Bigg)
\end{align*}

Similarly, 
\begin{align*}
	\xi_2(t,t+\Delta)&=\frac{2\nu}{\sqrt{\pi \tau} \times \left( \frac{1}{\tau^2}+\omega^2\right)}  \times \Bigg( \textcolor{red}{\int_t^{t+\Delta} \bigg( \frac{1}{\tau} \exp\left( -\frac{t+\Delta-u}{\tau}\right) \sin(\omega(t+\Delta-u))} \\
	&\textcolor{red}{-\omega \left( 1-\exp \left( -\frac{t+\Delta-u}{\tau}\right) \cos(\omega(t+\Delta-u))\right) \bigg)dW_1(u)} \\
	&  \textcolor{blue}{+\int_t^{t+\Delta} \bigg( \omega \exp\left( -\frac{t+\Delta-u}{\tau}\right) \sin(\omega(t+\Delta_u))} \\
	&\textcolor{blue}{+\frac{1}{\tau} \left(1-\exp\left(-\frac{t+\Delta-u}{\tau} \right) \cos(\omega(t+\Delta-u)) \right) \bigg) dW_2(u)} \Bigg)
\end{align*}

Denote 
\begin{align*}
	& \textcolor{red}{X_1=\int_t^{t+\Delta} \left( \frac{1}{\tau} \left(1-\exp\left( -\frac{t+\Delta-u}{\tau}\right) \cos(\omega(t+\Delta-u))\right) +\omega \exp \left( -\frac{t+\Delta-u}{\tau}\right) \sin(\omega(t+\Delta-u))\right)dW_1(u)} \\ 
	&\textcolor{red}{Y_1=\int_t^{t+\Delta} \left( \frac{1}{\tau} \exp\left( -\frac{t+\Delta-u}{\tau}\right) \sin(\omega(t+\Delta-u)) -\omega \left( 1-\exp \left( -\frac{t+\Delta-u}{\tau}\right) \cos(\omega(t+\Delta-u))\right) \right)dW_1(u)} \\
	&\textcolor{blue}{X_2=\int_t^{t+\Delta} \left( \omega \left(1-\exp\left( -\frac{t+\Delta-u}{\tau}\right) \cos(\omega(t+\Delta-u))\right)-\frac{1}{\tau} \exp\left(-\frac{t+\Delta-u}{\tau} \right) \sin(\omega(t+\Delta-u)) \right) dW_2(u)} \\
	&\textcolor{blue}{Y_2=\int_t^{t+\Delta} \left( \omega \exp\left( -\frac{t+\Delta-u}{\tau}\right) \sin(\omega(t+\Delta-u))+\frac{1}{\tau} \left(1-\exp\left(-\frac{t+\Delta-u}{\tau} \right) \cos(\omega(t+\Delta-u)) \right) \right) dW_2(u)} 
\end{align*}
so that both $X_1$,$Y_1$ and $X_2$
,$Y_2$ are independent and 
\[\xi_1(t,t+\Delta)=\frac{2\nu}{\sqrt{\pi \tau} \times \left( \frac{1}{\tau^2}+\omega^2\right)}  \times (X_1+Y_1) \quad \xi_2(t,t+\Delta)=\frac{2\nu}{\sqrt{\pi \tau} \times \left( \frac{1}{\tau^2}+\omega^2\right)}  \times (X_2+Y_2)\]
\[Var(\xi_1(t,t+\Delta))=\frac{4\nu^2}{\pi \tau \times \left( \frac{1}{\tau^2}+\omega^2\right)^2} (Var(X_1)+Var(Y_1)) \quad Var(\xi_1(t,t+\Delta))=\frac{4\nu^2}{\pi \tau \times \left( \frac{1}{\tau^2}+\omega^2\right)^2} (Var(X_2)+Var(Y_2)) \]

Itô's isometry yields
\begin{align*}
	Var(X_1)&=\int_t^{t+\Delta} \left( \frac{1}{\tau} \left(1-\exp\left( -\frac{t+\Delta-u}{\tau}\right) \cos(\omega(t+\Delta-u))\right) +\omega \exp \left( -\frac{t+\Delta-u}{\tau}\right) \sin(\omega(t+\Delta-u))\right)^2du \\
	&= \int_0^{\Delta} \left( \frac{1}{\tau} \left(1-\exp\left( -\frac{u}{\tau}\right) \cos(\omega u)\right) +\omega \exp \left( -\frac{u}{\tau}\right) \sin(\omega u)\right)^2du 
\end{align*}
Similarly, 
\[
Var(Y_1)=\int_0^{\Delta} \left( \frac{1}{\tau} \exp\left( -\frac{u}{\tau}\right) \sin(\omega u) -\omega \left( 1-\exp \left( -\frac{u}{\tau}\right) \cos(\omega u)\right) \right)^2 du
\]
Hence,
\begin{align*}
	Var(\xi_1(t,t+\Delta))&=\frac{4\nu^2}{\pi \tau \times \left( \frac{1}{\tau^2}+\omega^2\right)^2} \Bigg( \int_0^{\Delta} \left( \frac{1}{\tau} \left(1-\exp\left( -\frac{u}{\tau}\right) \cos(\omega u)\right) +\omega \exp \left( -\frac{u}{\tau}\right) \sin(\omega u)\right)^2+ \\
	& \left( \frac{1}{\tau} \exp\left( -\frac{u}{\tau}\right) \sin(\omega u) -\omega \left( 1-\exp \left( -\frac{u}{\tau}\right) \cos(\omega u)\right) \right)^2 du\Bigg)
\end{align*}

It is possible to see that the formula is exactly the same for $\xi_2(t,t+\Delta)$.

The time integral can be calculated explicitly to obtain
\begin{align*}
	Var(\xi_1(t,t+\Delta))&=Var(\xi_2(t,t+\Delta))=\frac{4\nu^2}{\pi \tau \times \left( \frac{1}{\tau^2}+\omega^2\right)} \times \\
	& \left( \Delta-2 \frac{\omega \sin(\omega \Delta)-\frac{1}{\tau} \cos(\omega \Delta)}{\frac{1}{\tau^2}+\omega^2 } \exp\left( -\frac{\Delta}{\tau} \right) +\frac{\tau}{2} \left( \frac{\omega^2-\frac{3}{\tau^2}}{\frac{1}{\tau^2}+\omega^2}-\exp\left( -\frac{2\Delta}{\tau}\right)\right) \right)
\end{align*}
It is easy to check that when $\omega=0$, the formula match the one for the basic correlated velocity model the hidden state. \\
With similar calculations, it can be shown that
\[Cov(\xi_1(t,t+\Delta), \xi_2(t,t+\Delta)=0\]

\subsection{State space model, simulation and parameter estimation}
WIth the same notation as before, for $j \in \{1,\cdots,,n\}$, denote $\alpha_j=\begin{pmatrix} x_{1j} & x_{2j} & v_{1j}-\mu_1 & v_{2j}-\mu_2 \end{pmatrix}^\top$.
To formulate a state space model, we shall need the covariances between the velocity and the locations.
Calculations similar to  section \ref{RACVM location process} give for all $t \geq 0$, $\Delta >0$
\begin{align*}
	Cov(\xi_1(t,t+\Delta),\zeta_1(t,t+\Delta))&=Cov(\xi_2(t,t+\Delta)\zeta_2(t,t+\Delta))=\frac{4\nu^2}{2 \pi \tau \times \left( \frac{1}{\tau^2}+\omega^2\right)} \times \\
	& \left( 1+\exp\left( -\frac{2\Delta}{\tau}\right)-2\exp\left( -\frac{\Delta}{\tau}\right)-2\exp\left( -\frac{\Delta}{\tau}\right) \cos(\omega \Delta)\right)
\end{align*}

\begin{align*}
	Cov(\xi_1(t,t+\Delta),\zeta_2(t,t+\Delta))&=Cov(\xi_2(t,t+\Delta),\zeta_1(t,t+\Delta))=\frac{4\nu^2}{2 \pi \tau \times \left( \frac{1}{\tau^2}+\omega^2\right)} \times \\
	&\left( \exp\left( -\frac{\Delta}{\tau}\right) \sin(\omega \Delta)-\frac{\omega \tau}{2} \left(1-\exp\left( -2 \frac{\Delta}{\tau}\right) \right)\right)
\end{align*}



Therefore, the recursive equations for the state space are
\begin{align*}
	\forall j \in \{1, \cdots, n\}&, \quad 
	\left\{ \begin{array}{l}
		y_j=x_j+\varepsilon_j \\
		v_{j+1}=\mu +\exp(-A\Delta_j)(v_j-\mu)+\zeta_j \\
		x_{j+1}=x_j+\mu \Delta_j+A^{-1}(I_2-\exp(-A\Delta_j))(v_j-\mu)+\xi_j
	\end{array}\right. \\
	&\Leftrightarrow \left\{ \begin{array}{l}
		y_j=Z\alpha_j+\varepsilon_j \\
		\alpha_{j+1}=T_j \alpha_j+B_j \mu + \eta_j
	\end{array}\right.
\end{align*}
where $Z=\begin{pmatrix} I_2 & 0_2 \end{pmatrix}$, $T_j=\begin{pmatrix} I_2 & A^{-1}(I_2-\exp(-A\Delta_j)) \\
	0_2 & \exp(-A\Delta_j) \end{pmatrix}$, $B_j=\begin{pmatrix}
	\Delta_j I_2 \\
	0_2 \end{pmatrix}$ and $\eta_j=\begin{pmatrix} \xi_j \\ \zeta_j\end{pmatrix}=\begin{pmatrix} \xi(t_j,t_j+\Delta_j) \\ \zeta(t_j,t_{j+\Delta_j})\end{pmatrix} \sim \mathcal{N}(0,Q_j)$ with 
\[Q_j=\begin{pmatrix} 
	Var(\xi_{1,j} & 0 & Cov(\xi_{1,j},\zeta_{1,j}) & Cov(\xi_{1,j},\zeta_{2,j})) \\
	\cdots & Var(\xi_{2,j}) & Cov(\xi_{2,j}, \zeta_{1,j}) & Cov(\xi_{2,j},\zeta_{2,j}) \\
	\cdots & \cdots & Var(\zeta_{1,j}) & 0 \\
	\cdots & \cdots & \cdots & Var(\zeta_{2,j}) 
\end{pmatrix}\] 



\subsection{Kalman filter equations and likelihood}

Now, the conditional law of $\alpha_i$ knowing $y_{1:i}$ is $\mathcal{N}(\hat{\alpha}_i,R_i)$ and the conditional law of $\alpha_i$ knowing $y_{1:i-1}$ is $\mathcal{N}(\hat{\alpha}_i^-,R_i^-)$ where the expectation and covariance matrices are computed as follows.

\paragraph{Kalman filter equations}
\subparagraph{initialization:}
\[\hat{\alpha}_0=\mathbb{E}(\alpha_0)=\begin{pmatrix} \mathbb{E}(x_{1,0}) \\ \mathbb{E}(x_{2,0})  \\ \mathbb{E}(v_{1,0})-\mu_1 \\ \mathbb{E}(v_{2,0})-\mu_2\end{pmatrix} \quad R_0=\begin{pmatrix} Var(x_{1,0}) & 0 & 0 & 0 \\ 0 & Var(x_{2,0})  & 0 \\ 0 & 0 & Var(v_{1,0}) & 0 \\ 0 & 0 & 0 & Var(v_{2,0}) \end{pmatrix}\]
\subparagraph{prediction:}
For $j \in \{2,\cdots,N\}$,
\[\hat{\alpha}_j^-=\tilde{T}_{j-1} \hat{\alpha}_{j-1}+ \tilde{B}_{j-1} \mu\]
\[ R_j^{-} = \tilde{T}_{j-1} R_{j-1} \tilde{T}_{j-1}^\top + \tilde{Q}_{j-1}\]
\subparagraph{correction:}
\[K_j=R_j^- \tilde{Z}^\top \left( \tilde{Z} R_j^- \tilde{Z}^\top +H_j\right)^{-1} \]
\[\hat{\alpha}_j=\hat{\alpha_j}^{-}+K_j \left( y_j-\tilde{Z} \hat{\alpha}_j^-\right)\]
\[R_j=\left(I_4-K_j \tilde{Z} \right) R_j^-\]
where $I_4$ is the $4 \times 4$ identity matrix. \\

From these equations we can deduce the likelihood of an observation $y^*=\begin{pmatrix} y_1^* &\cdots& y_n^* \end{pmatrix}$.\\
Since $y_j=\tilde{Z}\alpha_j+\varepsilon_j$,  $\alpha_j \vert y_{1:j-1} \sim \mathcal{N}(\hat{\alpha}_j^-,R_j^-)$, and $\varepsilon_j \sim \mathcal{N}(0,H_j)$ is independent from the observations, we have
\[y_j \vert y_{1:j-1} \sim \mathcal{N}\left(\tilde{Z} \hat{\alpha}_i^-,\tilde{Z} R_i^- \tilde{Z}^\top+H_i \right)\]



Thus, if one writes $m_i=\tilde{Z} \hat{\alpha}_i^-$ and $\Gamma_i=\tilde{Z} R_i^- \tilde{Z}^\top +H_i$ then 
\[\mathcal{L}(\sigma, \beta, \mu \vert y^*) =\mathbb{P}(y_0=y_0^*) \prod_{i=2}^n \mathbb{P}(y_i=y_i^* \vert y_{1:i-1}=y_{1:i-1}^*)\]
If we suppose that the initial observation is fixed (not random), then
\[\mathcal{L}(\sigma, \beta, \mu \vert y^*) = \prod_{i=2}^n \frac{1}{\sqrt{(2\pi)^2 \vert \det(\mu_i) \vert}} \exp \left( -\frac{1}{2} (y_i^*-m_i)^\top \Gamma_i^{-1} (y_i^*-m_i) \right) \]
Hence, the log-likelihood is 
\begin{align*}
    \log \left(\mathcal{L}(\sigma,\beta,\mu \vert y^*)\right)&=\sum_{i=2}^n -\log(\sqrt{(2\pi)^2 \vert \det(\Gamma_i) \vert}) -\frac{1}{2} (y^*_i-m_i)^\top \Gamma_i^{-1} (y^*_i-m_i)\\
    &=\sum_{i=2}^n -\frac{1}{2}\log\left((2\pi)^2 \vert \det(\Gamma_i) \vert\right) -\frac{1}{2} (y^*_i-m_i)^\top \Gamma_i^{-1} (y^*_i-m_i) \\
    &=-(n-1)\log(2\pi)-\frac{1}{2} \sum_{i=2}^n \log(\vert \det(\Gamma_i) \vert) +(y^*_i-m_i)^\top \Gamma_i^{-1} (y^*_i-m_i)
\end{align*}
Consequently, the negative log-likelihood that we need to minimize to obtain parameter estimates is 
\[
-\log \left(\mathcal{L}(\sigma,\beta,\mu \vert y^*)\right)=(n-1)\log(2\pi)+\frac{1}{2} \sum_{i=2}^n \log(\vert \det(\mu_i) \vert) +(y^*_i-m_i)^\top \mu_i^{-1} (y^*_i-m_i)
\]

The estimated parameters are 
\[\hat{\theta}=(\hat{\sigma},\hat{\beta},\hat{\mu})=\underset{\sigma,\beta,\mu}{\mathrm{argmin}} \left( \sum_{i=2}^n \log(\vert \det(\Gamma_i) \vert) +(y^*_i-m_i)^\top \Gamma_i^{-1} (y^*_i-m_i) \right) \]

\section{Precisions about the statistical models}
\label{section: precisions about statistical models}
In the baseline mixed effect model, the explicit model matrices are 

\[X_{pre}= \begin{bNiceArray}{ccc|ccc}[margin]
	1 & 0 & 0 & \Block{3-3}<\Large>{0} & &  \\
	\vdots & \vdots & \vdots & & &  \\
	1 & 0 & 0 & & & \\
	\hline
	0 & 1 & 0 &  \Block{3-3}<\Large>{0} & & \\
	\vdots & \vdots & \vdots & & &  \\
	0 & 1 & 0 & & & \\
	\hline
	0 & 0 & 1 &  \Block{3-3}<\Large>{M_{pre}} & & \\
	\vdots & \vdots & \vdots & & &  \\
	0 & 0 & 1 & & & \\
\end{bNiceArray} \quad 
Z_{pre} = \begin{pmatrix}
	J_{1,n_1} \\
	\vdots \\
	J_{6,n_6} \\
	\vdots \\
	J_{13,n_1} \\
	\vdots \\
	J_{18,n_6}
\end{pmatrix} 
\]
where $M_{pre}$ is the matrix with elements  $\psi_k(E^{(i)}_{shore}(t^{(i)}_j))$ on column $k$ and row associated to observation $j$ for narwhal $i$, and $J_{l,m}$ is the matrix with $m$ rows and $18$ columns that has zero everywhere except on column $l$, where there are only ones.

\end{document}