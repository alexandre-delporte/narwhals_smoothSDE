---
title: "Preprocessing and exploration of the narwhal data for the analysis with smoothSDE"
author: "Alexandre Delporte"
date: "2023-03-01"
output: 
  pdf_document: default
  html_document: default
editor_options:
  markdown:
    wrap: sentence
---

# Set up

## Set up Rmarkdown options

```{r options}
knitr::opts_chunk$set(echo = TRUE, error = TRUE, eval = TRUE)
```

## Import necessary packages

```{r libraries,message=FALSE}

#to get root of git repo
library(here)

#for tex code
library(tinytex)

#for the plots
library(ggplot2)
library(plotly)

#to manage dataframes 
library(dplyr)

#to get polygons for the shore
library(jsonlite)
library(sf)

#to convert to UTM coordinates
library(sp)

#to get stamenmap
library(ggmap)

#to get animation of the narwhals trajectories
library(gganimate)
library(transformr)
library(gifski)

#to show progress bars
library(progress)

#to get function na.approx to replace NA values by interpolation
library(zoo)

```

## Choose directory where the plots should be saved

```{r create plots folder}

plots_folder <-"exploratory_plots"

if (!(dir.exists(plots_folder))) {
  dir.create(plots_folder)
}

```

# Explore raw data

## Read
Takes a few minutes to read the whole dataset.

```{r read raw data,cache=TRUE}
# Set the path to the directory containing the raw data for narwhals
raw_narwhal_data_path <- here(file.path("Data","raw_data","narwhals"))

#get narwhal data
data_file="db_narwhal_2017_2018_with_gps.txt"
rawData <- read.table(file.path(raw_narwhal_data_path,data_file),
                      header = TRUE, sep = "\t",dec = ".")

```

## Summary

```{r summary raw data}
print(summary(rawData))
```

```{=tex}
Here is a brief description of the raw dataframe.
We have $4132760$ observations and $32$ variables.
The columns are
\begin{itemize}
\item \texttt{rawData\$Posixct} : The date and hour in characters
\item \texttt{rawData\$Depth} : The narwhal depth in metres. It goes from $0$ to $-1044$ metres. The GPS positions given by \texttt{rawData\$Lat} and 
\texttt{rawData\$Long} should be known only when depth is reasonably low (close to 0). 
\item \texttt{rawData\$ODBA} : overall dynamic body acceleration, sometimes used as a proxy for energy expenditure, expressed in $m/s^{-2}$ or in $g$ ($1 g=9.8 m s^{-2}$). It is computed from accelerometer data (see "Moving towards acceleration for estimates of
activity-specific metabolic rate in free-living animals: the case of the cormorant)" wILSON 2006 for details.
\item \texttt{rawData\$VeDBA} : vector dynamic body acceleration
\item \texttt{rawData\$Acou\_qua} : 
\item \texttt{rawData\$GPS\_time} : character for date and time when signal was emitted by the GPS : $54$ seconds ahead compared to \texttt{rawData\$Posixct}
\item \texttt{rawData\$Lat} : latitude in $[-90,90]$ degrees in the World Geodetic System 1984. It is either a latitude measure by the GPS or linearly interpolated using previous and next latitude.
\item \texttt{rawData\$DistanceShore} : distance to the nearest shore point, in metres.
\item \texttt{rawData\$Long] : }  longitude in $[-180,180]$ degrees in the World Geodetic System 1984. It is either a latitude measure by the GPS or linearly interpolated using previous and next latitude.
\item \texttt{rawData\$LOS} : binary variable : 1 if the narwhal is in Line of sight from the ship, 0 otherwise.
\item \texttt{rawData\$Seismik} : binary variable
\item \texttt{rawData\$Type} : categorical variable with values "trial" when the narwhal is exposed to the ship and the ship is shooting airguns,
"intertrial" when the narwhal is exposed to the ship without airguns being shot.
\item \texttt{rawData\$TrialNo} : categorical variable with values "T1", ..., "T8", "I1", ..., "I9" where the letter stands for the type 
(intertrial  or trial) and the number for the number of the trial.
\item \texttt{rawData\$Exposure} : categorical variable with levels from 1 to 8.
\item \texttt{rawData\$Year} : year when the data was collected
\item \texttt{rawData\$Click} : binary variable, indicating whether the narwhal is emitting click sounds or not
\item \texttt{rawData\$Call} : binary variable, indicating whether the narwhal is emitting call sounds or not
\item \texttt{rawData\$Buzz} : binary variable, indicating whether the narwhal is buzzing
"The closer the narwhals get to their food, the faster they click, until the noise becomes a buzz". Calls are emitted for communication with
other individuals.
\item \texttt{rawData\$Dist\_Ship} : Distance to the military ship in metres
\item \texttt{rawData\$Area} : categorical variable with "IF" "R"  "O"  "H"  "OG" (outer Gasefjord) "G"  "Vi" "F"(Fonfjord)  "IG" matching the area in Scoresby Sound :

\item \texttt{rawData\$GunSize} : categorical variable with values "B" (big) and "S" (small). 
Big airguns were used only in 2018, and small airgun in 2017 (see Jorgensen 2021)
\item \texttt{rawData\$temperatureCorrected} : 
\item \texttt{rawData\$Dist\_to\_CPA} : Distance in km to the closest point of approach (CPA), that is the point where the narwhals and the ship would be the 
closest if they kept moving linearly (see "CPA calculation method based on AIS position prediction", Yan)
\item \texttt{rawData\$Time\_to\_CPA} : time needed to reach the CPA (I don't get why some values are negative)
\item \texttt{rawData\$Direction\_cat} : categorical variable with values "increasing" or "decreasing".
\item \texttt{rawData\$NoOfStrokes\_20sec} : number of strokes per 20 seconds
\item \texttt{rawData\$Divecat} : categorical variable with values "S", "M", "D" (for surface, medium, deep ?).
\item \texttt{rawData\$Target\_depth} : target depth in metres
\item \texttt{rawData\$Dive\_phase} : categorical variable with values "surface","Descent","Bottom","Ascent","0".
\item \texttt{rawData\$GPS\_time\_chr} : Character for the date and time : this column is identical to column rawData\$GPS\_time. Can be deleted
\item \texttt{rawData\$pos\_org} : binary variable with value $0$ if latitude and longitude have been interpolated, $1$ if it is an actual GPS measure.
\end{itemize}
```

# First preprocessing steps

```{=tex}
Two controlled exposure experiments were performed in 2017 and 2018.
The main differences are that only small guns were used in 2017 while only big guns were used in 2018, and the tagged whales used a much larger part of Scoresby Sound in 2018. More interesting results were found in 2018 in the paper of Mads-Peter, Adeline and Susanne. We primarily focus on this data rather than the 2017 data.

First preprocessing steps include : 
\begin{itemize}
\item keeping only 2018 data and adding a time since tagging column 
\item converting distance to ship and distance to shore to km and adding an ExpShip column defined as the inverse of the \texttt{Dist\_Ship} column when the narwhals are in line of sight from the boat.\texttt{ExpShip} is a proxy for sound exposure level (SEL).
\item Renaming the "Ind" column to "ID" for clarity and converting it to factors.
\item Converting column "Type" in factor with levels trial and intertrial, and adding two columns "ExpShipT" and "ExpShipI" for exposure to ship during trial and intertrial separately
\item Converting column "Posixct" to POSIXct format for date and time
\end{itemize}

The first measurement time is set to $1$ second and then measures are interpolated every second (see Jorgensen et al.).
Thus, the time $T_k$ of the $k$-th measurement is $$T_{k}=\frac{k}{3600}\mbox{ h }$.


```

```{r preprocess data 1}

#keep only 2018 data
data=rawData[rawData$Year==2018,]

#add time since tagging column

TimeFunction <- function(n, dt = 1){
  ## n: Number of observations. Positive integer
  ## dt: Time step between observations in seconds
  Time <- (1:n)*(dt/3600) ## Time in hours since tagging
}

nrows=length(data[,1])
data$time <- rep(0,nrows)
for(ind in unique(data$Ind)){
  indicator <- (data$Ind == ind)
  data$time[indicator] <- TimeFunction(n = sum(indicator))
}


#convert Distance Shore and Dist_ship to km
data$Dist_Ship=data$Dist_Ship/1000
data$DistanceShore=data$DistanceShore/1000


## Defining exposures

ExposureFunction <- function(X){
  ## X: Distance to ship in meters measured each second. Supposed to be positive
  
  ## Exposure variable
  E <- 1/X ## Inverse of distance to ship in kilometers
  E[is.na(E)] <- 0 ## If not in line of sight, exposure is zero
  E
}

## Ship Exposure variable based on 1/distance in km
data$ExpShip <- ExposureFunction(X = data$Dist_Ship) 


#change name of the IDs column to ID
colnames(data)[1]="ID"
data$ID=factor(data$ID)

#convert Type to factors
data$Type <- factor(data$Type, levels = c("intertrial", "trial"))

data$ExpShipI=data$ExpShip
data$ExpShipT=data$ExpShip

data$ExpShipI[data$Type=="trial"]=0
data$ExpShipT[data$Type=="intertrial"]=0

#convert Posixct to POSIXct class for time and dates
data$Posixct=as.POSIXct(data$Posixct)
```

# Trials and intertrials periods exploration

```{=tex}
During the experiment, two types of exposure can be distinguished
\begin{itemize}
\item[1] Trials : Narwhals are in line of sight with the military ship and the ship is shooting airguns in the sea.
\item[2] Intertrials: Narwhals are in line of sight with the military ship but it has stopped shooting airguns.
\end{itemize}
See Jorgensen et al. for more details.
```

```{r plot trials}


#plot with all the narwhals rescaled so that the experiments start at the same time 
trials_rescaled=ggplot(data[!is.na(data$Type), ], aes(time/24,ID,fill=Type)) + 
  xlab("Number of days after tagging")+ylab("Exposure")+
  geom_tile(lwd = 1,linetype = 1)+ 
  scale_fill_manual(values=c("blue","red"),na.value="white",
                    name="Trial type",labels=c("Intertrial","Trial"))+
  scale_y_discrete(labels=c("A1", "A2", "A3", "A4","A5", "A6"))+theme_minimal()



#plot with all the narwhals at the real experiments time
trials=ggplot(data[!is.na(data$Type), ], aes(Posixct,ID,fill=Type)) + 
  xlab("Day")+ylab("Exposure")+
  geom_tile(lwd = 1.5,linetype = 1)+ 
   scale_fill_manual(values=c("blue","red"), na.value="white",
                     name="Trial type",labels=c("Intertrial","Trial"))+
  scale_y_discrete(labels=c("A1", "A2", "A3", "A4","A5", "A6"))+theme_minimal()

ggsave(path=plots_folder,filename="trials_rescaled.png",plot=trials_rescaled,width=10,height=5)
ggsave(path=plots_folder,filename="trials.png",plot=trials,width=10,height=5)
```


The exposure is not smooth with respect to time, because a narwhal can be highly exposed at some time and be completely out of sight from the airguns a few seconds later, and also because the airguns shooting stops abruptly.
This phenomenon appears when the values in DistShip suddenly change to NA.

Moreover, exposure times are relatively short compare to the overall duration of the measurement period, so that most of the time, ExpShip is zero but short peaks appear when trials or intertrials are happening.
We can zoom on these peaks for a better visualization.

```{r ggplot ship exposure}
#plot exposure
pExpAll=ggplot(data,aes(time,ExpShip,col=ID))+geom_line()+
  scale_color_viridis_d(labels=c("A1","A2","A3","A4","A5","A6"))+theme_minimal()

#plot exposure during intertrial
pExpInt=ggplot(data,aes(time,ExpShipI,col=ID))+geom_line()+
  scale_color_viridis_d(labels=c("A1","A2","A3","A4","A5","A6"))+theme_minimal()

#plot exposure during trial
pExpTr=ggplot(data,aes(time,ExpShipT,col=ID))+geom_line()+
  scale_color_viridis_d(labels=c("A1","A2","A3","A4","A5","A6"))+theme_minimal()


ggsave(path=plots_folder,filename="exposure_through_time.png",
       pExpAll,width=10,height=5)
ggsave(path=plots_folder,filename="intertrial_exp_through_time.png",
       pExpInt,width=10,height=5)
ggsave(path=plots_folder,filename="trial_exp_through_time.png",
       pExpTr,width=10,height=5)



```

```{r display pExpAll, fig.cap="Global exposure to ship through time"}
pExpAll
```

```{r display pExpTr, fig.cap="Trial exposure to ship through time"}
pExpTr
```

```{r display pExpInt, fig.cap="Intertrial exposure to ship through time"}
pExpInt
```


# Second preprocesssing step

```{=tex}
\textbf{\texttt{Lat} and \texttt{Long} columns have been interpolated every second, and distance to ship has been computed from these interpolations.The true measured distance to ship are in the rows for which the column \texttt{pos\_org}  has value 1.}
We will drop the interpolated positions for the analysis.
```

```{=tex}
The next step consists in :
\begin{itemize}
\item  Dropping missing latitude and longitude.
\item Keeping only GPS positions indicated by value 1 in \texttt{pos\_org} column.
\item  The narwhal positions are in latitude and longitude. To analyze the track and visualize it better we project it on a plane in UTM coordinastes. Hence, we project to UTM zone north 26 (https://epsg.io/32626).
\item We add a column "speed" with empirical horizontal speed obtained from the GPS positions (not interpolated)
\end{itemize}

```


```{r preprocess data 2}

#remove rows with missing positions
dataprep=data[!(is.na(data$Lat)) & !(is.na(data$Long)),]

#keep rows indicated as GPS measurements
dataprep=dataprep[dataprep$pos_org==1,]

#number of rows
nrows=length(dataprep[,1])


#project to UTM (Universal Transverse Mercator coordinate system)

llcoord=SpatialPoints(dataprep[,c("Long","Lat")],
                      proj4string=CRS("+proj=longlat +datum=WGS84"))
utmcoord=spTransform(llcoord,CRS("+proj=utm +zone=26 +north,ellps=WGS84 +units=km"))

#add UTM locations in km to data frame
dataprep$x=attr(utmcoord,"coords")[,1]
dataprep$y=attr(utmcoord,"coords")[,2]

#compute empirical horizontal speed
dataprep$horizontal_speed=rep(NA,nrows)
  
  
rows_index=c()
for (id in unique(dataprep$ID)){
  
  #filter data with specific id
  sub_ind=(dataprep$ID==id)
  sub_data=dataprep[sub_ind,]
  n_sub=length(sub_data$time)
  
  #time steps
  dtimes=sub_data[2:n_sub,"time"]-sub_data[1:(n_sub-1),"time"]
  
  #step lengths
  dx=(sub_data[2:n_sub,"x"]-sub_data[1:(n_sub-1),"x"])
  dy=(sub_data[2:n_sub,"y"]-sub_data[1:(n_sub-1),"y"])
  
  speed=c(NA,sqrt((dx/dtimes)^2+(dy/dtimes)^2))
  
  dataprep[sub_ind,"horizontal_speed"]=speed
}

```



# Data exploration after second preprocessing

## True exposure per individual

```{=tex}
We plot exposure from interpolated positions and highlight points that are directly observed exposures, that is exposure levels computed from the actual GPS position of the narhwal compared to the GPS position of the ship.

```

```{r plot exposure per individual}

for (id in unique(data$ID)) {
  plot_exp=ggplot(data[data$ID==id,],aes(time,ExpShip))+geom_line()+
  geom_point(data=data[(data$pos_org==1)&(data$ID==id),],
             aes(time,ExpShip),shape=3,colour="red",size=1)
  
  ggsave(path=plots_folder,
         filename=paste(id,"ship_exposure_through_time.png",sep="_"),
         plot_exp,width=10,height=5)
}
```

```{r example of individual exposure with red points for measured values, fig.cap=""}
ggplotly(plot_exp)
```

## Measurement periods for each narwhal

```{r measurement periods}
#print measurement periods for each narwhal

for (id in unique(dataprep$ID)) {
  dataid=dataprep[dataprep$ID==id,]
  print(paste(id,"measurement period : ",min(as.POSIXct(dataid$Posixct)),"to",
              max(as.POSIXct(dataid$Posixct))))
}
```

## Explore horizontal speed

```{r summary horizontal speed}
summary(dataprep$horizontal_speed)
```

```{=tex}
The mean speed is about 4.5 km/h.
Usually, computing the empirical horizontal speed between two positions amounts to consider that the narwhal moved in a straight line between
the two points. But this is obviously not true, especially for long time steps, because the narwhal make U-turns for instance. Therefore the empirical horizontal speed always underestimates the true horizontal speed.
Anormal values of the speed may indicate outliers to remove from the data.  While there is no reason to drop low speed values, since the narwhals can well rest for some time, high speed values that are clearly outliers and could not have been reached by a narwhal might be removed from the data.
Here we clearly see some outliers in the histogram.
```

```{r histogram horizontal speed,warnings=FALSE}
speed_histo=ggplot(dataprep, aes(x =horizontal_speed,col=ID)) +
  geom_histogram(fill="white",bins=50)+facet_grid(ID ~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  scale_color_viridis_d(guide="none")+
  theme(legend.position="top")+xlab("Empirical horizontal speed (km/h)")+theme_minimal()

speed_histo
ggsave(path=plots_folder,"speed_histo.png", plot = speed_histo)
```



## Filter horizontal speed

```{=tex}
We thus decide to filter by setting a threshold of $20$ km/h for horizontal speed.
```

```{r speed higher than 20km/h }
dataprep[dataprep$horizontal_speed>20,c("ID","time","horizontal_speed")]
```

```{=tex}
There are only two horizontal speeds (both for Kyrri track) higher than $20$ km/h. We decide to keep this threshold of 20 km/h to filter the rows.
```

```{r remove rows with speed > 20km/h}
rows_index=which(dataprep$horizontal_speed>20)
dataprep=dataprep[-rows_index,]
```

```{r check filtered dataprep}
#check that now all speeds are inferior to 20 km/h
dataprep[dataprep$horizontal_speed>20,]
```

```{r histogram filtrered horizontal speed,warnings=FALSE}
speed_histo_filtered=ggplot(dataprep, aes(x =horizontal_speed,col=ID)) +
  geom_histogram(fill="white",bins=50)+facet_grid(ID ~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  scale_color_viridis_d(guide="none")+
  theme(legend.position="top")+xlab("Empirical horizontal speed (km/h)")+theme_minimal()

speed_histo_filtered
ggsave(path=plots_folder,"speed_histo_filtered.png", plot = speed_histo_filtered)
```
## Time steps distribution 

```{=tex}
Now that we removed the interpolated positions, we can check the time step distribution to get the frequence of acquisition of the narwhals Fastloc GPS device.
```

```{r compute time steps,warnings=FALSE}

dtimes=data.frame("delta"=rep(NA,nrow(dataprep)),"ID"=rep(NA,nrow(dataprep)))

for (id in unique(dataprep$ID)) {
  ind=dataprep$ID==id
  data_id=dataprep[ind,]
  nrows=length(data_id[,1])
  delta_id=data_id[2:nrows,"time"]-data_id[1:(nrows-1),"time"]
  delta_id=c(NA,delta_id)
  dtimes[ind,"delta"]=delta_id
  dtimes[ind,"ID"]=rep(id,nrows)
}

```

```{r summary time steps, cache=FALSE, echo=TRUE}
print(summary(dtimes$delta*60))
```


```{r time steps histogram}
times_histo=ggplot(dtimes, aes(x =60*delta,col=ID)) +
  geom_histogram(fill="white",bins=100)+facet_grid(ID ~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  scale_color_viridis_d(guide="none")+
  theme(legend.position="top")+xlab("Time step (min) ")+theme_minimal()


times_histo
ggsave(path=plots_folder,"time_steps_histo.png", plot = times_histo)
```

```{r time steps >2h, cache=FALSE, echo=TRUE}

cat("Percentage of time steps > 2h :",length(dtimes$delta[dtimes$delta>2])/length(dtimes$delta)*100)
```

```{r display hist , fig.cap="Histogram of time steps",warnings=FALSE}
all_times_histo=ggplot(data=dtimes,aes(x=60*delta))+geom_histogram(bins=120,color="black",fill="grey")+xlab("Time step (min)")+
  theme_minimal()
all_times_histo
ggsave(path=plots_folder,"all_time_steps_histo.png", plot = all_times_histo)
```

```{=tex}
The median of the time steps between consecutive measurement is about $5$ minutes.
Only two time steps exceed $4$h.
```

```{r}
all_times_histo_cropped=ggplot(data=dtimes[dtimes$delta<1,],aes(x=60*delta))+geom_histogram(bins=120,color="black",fill="grey")+xlab("Time step (min)")+
  theme_minimal()
all_times_histo_cropped
ggsave(path=plots_folder,"all_time_steps_histo_cropped.png", plot = all_times_histo_cropped)
```


## Plot all GPS tracks (without interpolation) on a map

```{r milne land map}
height <- max(dataprep$Lat) - min(dataprep$Lat)
width <- max(dataprep$Long) - min(dataprep$Long)
borders <- c(bottom  = min(dataprep$Lat), 
                 top     = max(dataprep$Lat),
                 left    = min(dataprep$Long),
                 right   = max(dataprep$Long))

register_stadiamaps(key ="a3062dd7-0f3d-44ea-a6ac-e11c9eeb94b4")
milne_land <- get_stadiamap(borders, zoom = 10, maptype = c("stamen_terrain"))
milne_land_map=ggmap(milne_land)

```

```{r trajectories map,cache=TRUE}

#static map
map=milne_land_map + 
  geom_point(dataprep[,c("ID","Long","Lat","time")],
             mapping=aes(Long, Lat, col = ID),size= 0.5,alpha=1) +
   geom_path(dataprep[,c("ID","Long","Lat","time")],mapping=aes(Long,Lat,col=ID),linewidth=0.1)+
  geom_point(data = dataprep[,c("ID","Long","Lat","time")] %>% filter(!duplicated(ID)),
             aes(x = Long, y = Lat,col=ID), shape = 3, size = 4,col = "red")+
  scale_color_viridis_d(labels=c("A1","A2","A3","A4","A5","A6"))+theme_minimal()

ggsave(path=plots_folder,filename="all_narwhals_tracks.pdf", 
       plot = map,width=10,height=5)

#animated map with gganimate
animate_map=milne_land_map + 
  geom_line(dataprep[,c("ID","Long","Lat","time")], 
            mapping=aes(Long, Lat, col = ID),size= 1,alpha=0.5) +
  scale_color_viridis_d(labels=c("A1","A2","A3","A4","A5","A6"))+transition_reveal(time)

animation=animate(animate_map,renderer = gifski_renderer())
anim_save(path=plots_folder,filename="all_narwhals_tracks.gif", 
          animation = animation,width=10,height=5)
```


```{r display map , fig.cap="All narwhal tracks"}
map
```

```{r save points as shapefile in data folder}
# Set the path to the directory containing the preprocessed data
preprocessed_narwhal_data_path <- here(file.path("Data","preprocessed_data","narwhals"))

points_sf <- st_as_sf(dataprep[,c("x","y")], coords = c("x","y"))
st_crs(points_sf)="+init=EPSG:32626 +units=km"
st_write(points_sf,file.path(preprocessed_narwhal_data_path,"narwhals_positions.shp"),append=FALSE)
```



# Land polygons data for the domain boundary

## Extract land polygons to define the border of the domain

We read the preprocessed land polygons extracted from OpenStreetMap database without modification except for cropping the polygons in the right bounding box and projecting it in EPSG 32626 to get UTM coordinates in km.

```{r extract land polygons}

# Set the path to the directory containing coastline data
preprocessed_greenland_data_path <- here(file.path("Data","preprocessed_data", "greenland"))

#get land polygons
scoresby_sound_utm<-st_read(file.path(preprocessed_greenland_data_path,"scoresby_sound_utm.shp"))

scoresby_sound_utm=st_transform(scoresby_sound_utm,crs= "+init=EPSG:32626 +units=km")
```

## Plot scoresby sound land

```{r plot coastline and land}
plot_land=ggplot()+geom_sf(data=scoresby_sound_utm$geometry,fill="grey",col="brown")
```

```{r display land , fig.cap="Land polygons"}
ggplotly(plot_land)
```



## Compute nearest point on land for each GPS position

```{r compute nearest shore points,cache=TRUE}

nearest_points=function(positions,border) {
  #positions: dataframe of positions in UTM coordinates in metres
  #border : geometry of the coastline projected in the same UTM zone as positions in metres
  
  # Create an empty vector to store the nearest points
  nearest_points <- matrix(nrow = nrow(positions), ncol = 2)
  min_distances<-matrix(nrow = nrow(positions), ncol = 1)
  
   #progress bar
  pb <- progress_bar$new(format = "[:bar] :percent",total = nrow(positions), clear = FALSE, width = 60)
  
  # Iterate over each position
  for (i in 1:nrow(positions)) {
  
    pb$tick()
  
    # Extract the position coordinates
    coords <- st_point(c(positions$x[i], positions$y[i]))
  
  
    # Initialize variables to store the minimum distance and nearest point
    min_distance <- Inf
    nearest_point <- NULL
 
  
    # Iterate over each polygon in border
    for (j in 1:length(border$geometry)) {
    
      # Get the current polygon
      polygon <- border$geometry[[j]]
    
      distance <- st_distance(coords,polygon)
    
      candidate=st_nearest_points(coords,polygon)
    
      coordinates=st_coordinates(candidate)[2,c("X","Y")]
    
      if (distance < min_distance) {
        min_distance=distance
        nearest_point=coordinates
      }
    }
  
    # Store the nearest point as an 'sf' point
    nearest_points[i, ] <- nearest_point
    min_distances[i,]<-min_distance
  }
  return (list("nearest_points"=nearest_points,"min_distances"=min_distances))
}
  
narwhal_positions=dataprep[,c("x","y")]

#nearest points in border and land

result=system.time({

res_land=nearest_points(positions=narwhal_positions,border=scoresby_sound_utm)
})

```

```{r computation time}
cat("Elapsed time:", result[3]/60, "minutes\n")
```

## Compare distances to shore from original data and computed distances to shore

```{r compare distances to shore}
plot(res_land$min_distances-dataprep$DistanceShore)
```

```{r summary distances to shore}
summary(res_land$min_distances)
summary(dataprep$DistanceShore)
```



```{r histograms distances to shore}
histo1=ggplot(dataprep[dataprep$DistanceShore>0,], aes(x = DistanceShore)) +
  geom_histogram(fill="cyan",bins=100,color="black")+xlab("Original distance to shore (km)")+
  theme_minimal()


df=data.frame(DistanceShore=res_land$min_distances[res_land$min_distances>0])
histo2=ggplot(df, aes(x =DistanceShore)) +
  geom_histogram(fill="cyan",bins=100,color="black")+xlab("Computed distance fom land (km)")+
  theme_minimal()
```

```{r display histograms}
histo1
histo2
```


## Points on land


```{r percentages of points on land}
cat("Percentage of points on land with the original distance to shore : \n",
    length(dataprep[dataprep$DistanceShore==0,"time"])/length(dataprep$time)*100,"\n")

cat("Percentage of points on land with distance from osm land polygons : \n",
    length(which(res_land$min_distances==0))/length(dataprep$time)*100,"\n")

```



## Check points on land on a map

Some points that appear on land on the map don't have distance to shore 0. This may be due to the map inaccuracy.

```{r check original points on land}
plot_original_inland_pts=ggplot()+geom_sf(data=scoresby_sound_utm$geometry,fill="grey")+
    coord_sf(datum=st_crs(32626))+
  geom_point(data=dataprep,aes(x,y,col=(DistanceShore==0)),size=0.2)+
    scale_color_viridis_d()

ggplotly(plot_original_inland_pts)
```


```{r inspect depth of points on land}
dataprep[dataprep$DistanceShore==0,c("Depth","time")]
```



```{r check osm points on land}
df=dataprep
df$DistanceShore=res_land$min_distances

plot_osm_inland_pts=ggplot()+geom_sf(data=scoresby_sound_utm$geometry,fill="grey")+
    coord_sf(datum=st_crs(32626))+
  geom_point(data=df,aes(x,y,col=(DistanceShore==0)),size=0.2)+
    scale_color_viridis_d()

ggplotly(plot_osm_inland_pts)
```

```{r percentage points on land per ID with osm map}

#percentage of points on land per ID
table(df[df$DistanceShore==0,"ID"])/table(dataprep$ID)*100


```


## Use land polygons updated with QGIS

```{=tex}
We need to know the nearest point on land to compute how the narwhal moves with respect to the land. For this, we need use the land polygons. In the original data, we have values for the Distance to shore, but we don't know exactly how it was computed. Approximately $2 \%$ of the narwhals positions are inland. This may be due to GPS measurement error, or errors in distance to shore computations. We notice that some points that have non zero distance to shore in the original data appear inland on the osm map. This suggests the osm map is not accurate. Indeed, as we have just seen, if we compute the distance to shore based on the osm polygon data, $9\%$ of the narwhal positions are inland. Thus, we decided to manually inspect the polygon data from OpenStreetMap with qgis software. We overlayed Sentinel-2 satellite images with the osm polygons data and the narwhals positions, and modified the shoreline to better match the original distance to shore and the satellite image. The resulting shapefile is updated_scoresby_sound_utm.shp.
```

```{r extract updated land polygons}

#get updated land polygons
updated_scoresby_sound_utm<-st_read(file.path(preprocessed_greenland_data_path,"updated_scoresby_sound_utm.shp"))

updated_scoresby_sound_utm <- st_transform(updated_scoresby_sound_utm, crs = "+init=EPSG:32626 +units=km")

```

```{r compute updated distance to shore}
res_updated_land=nearest_points(positions=narwhal_positions,border=updated_scoresby_sound_utm)

cat("Percentage of points on land with distance from updated osm land polygons : \n",
    length(which(res_updated_land$min_distances==0))/length(dataprep$time)*100,"\n")

```

```{r check updated osm points on land}
df=dataprep
df$DistanceShore=res_updated_land$min_distances

plot_updated_osm_inland_pts=ggplot()+geom_sf(data=updated_scoresby_sound_utm$geometry,fill="grey")+
    coord_sf(datum=st_crs(32626))+
  geom_point(data=df,aes(x,y,col=(DistanceShore==0)),size=0.2)+
    scale_color_viridis_d()

ggplotly(plot_updated_osm_inland_pts)
```

## Points too close to land

We expect the narwhals to stay at a certain distance from land, say 50 meters.
Let's check the distribution of points near land to choose a minimum value for the distance to shore below which we should drop the points.

```{r distribution of points close to the shore}

df=data.frame(DistanceShore=res_updated_land$min_distances[res_updated_land$min_distances<1 & res_updated_land$min_distances>0  ])
histo=ggplot(df, aes(x =DistanceShore)) +
  geom_histogram(fill="cyan",bins=100,color="black")+xlab("Computed distance to shore (km)")

histo
```



```{=tex}
A lot of points are indeed still very close to land. We think that this means the shoreline is still not accurate. To solve the problem, we translate the polygon vertices 200m inward. We compute new distances to shore based on the translated polygon.

```

```{r get shrunk polygons}

#get updated land polygons
shrunk_scoresby_sound_utm<-st_read(file.path(preprocessed_greenland_data_path,"shrunk_updated_scoresby_sound_utm.shp"))

shrunk_scoresby_sound_utm <- st_transform(shrunk_scoresby_sound_utm, crs = "+init=EPSG:32626 +units=km")

```

```{r compute updated translated distance to shore}
res_shrunk_land=nearest_points(positions=narwhal_positions,border=shrunk_scoresby_sound_utm)

cat("Percentage of points on land with distance from shrunk updated osm land polygons : \n",
    length(which(res_shrunk_land$min_distances==0))/length(dataprep$time)*100,"\n")

```

```{r distribution of points close to the shore}

df=data.frame(DistanceShore=res_shrunk_land$min_distances[res_shrunk_land$min_distances<1 & res_shrunk_land$min_distances>0  ])
histo=ggplot(df, aes(x =DistanceShore)) +
  geom_histogram(fill="cyan",bins=100,color="black")+xlab("Computed distance to shore (km)")

histo
```


# Third preprocessing step

##  Add distance and coordinates of the nearest shore point in the dataframe

```{r add shore points to the df}

#keep points calculated from land polygons
nearest_points=res_updated_land$nearest_points
min_distances=res_updated_land$min_distances

#add columns px and py with coordinates of the nearest point on the shore line
dataprep$px=nearest_points[,1]
dataprep$py=nearest_points[,2]

# add columns with difference between narwhal position and nearest point on the shoreline
dataprep$nx=dataprep$x-dataprep$px
dataprep$ny=dataprep$y-dataprep$py

#replace distance to shore with distances calculated from land polygons (in km)
dataprep$DistanceShore=min_distances

#same for shrunk polygons
nearest_points_shrunk=res_shrunk_land$nearest_points
min_distances_shrunk=res_shrunk_land$min_distances

#add columns px and py with coordinates of the nearest point on the shore line
dataprep$px_translated=nearest_points_shrunk[,1]
dataprep$py_translated=nearest_points_shrunk[,2]

# add columns with difference between narwhal position and nearest point on the shoreline
dataprep$nx_translated=dataprep$x-dataprep$px_translated
dataprep$ny_translated=dataprep$y-dataprep$py_translated
dataprep$DistanceShore_translated=min_distances_shrunk
```



# Add shore exposure covariate


```{r}
#add Ishore covariate based on 1/distance in km
dataprep$Ishore <- ExposureFunction(X = dataprep$DistanceShore) 

#add Ishore covariate based on 1/distance in km
dataprep$Ishore_translated <- ExposureFunction(X = dataprep$DistanceShore_translated) 

```

# Some quantities of interest : empirical velocities and deviation angles

## Compute deviation angles related to the shore

```{r empirical velocities and deviation angles}

signed_angle <- function(u, v) {
    #Compute signed angle in [-pi,pi] that rotates first vector into second vector 
    # as in 
    # https://math.stackexchange.com/questions/529555/signed-angle-between-2-vectors
    u <- matrix(u, ncol = 2)
    v <- matrix(v, ncol = 2)
    if (nrow(u) != nrow(v)) stop("u and v must have the same number of 
                                  rows")
    result <- as.numeric(atan2(v[,2], v[,1]) - atan2(u[,2], u[,1]))
    ind1 <- which(result > pi)
    ind2 <- which(result <= -pi)
    result[ind1] <- result[ind1] - 2*pi
    result[ind2] <- result[ind2] + 2*pi
    return(result) 
} 


#observed deviation angles
n=length(dataprep$time)

dataprep$AngleShore=rep(NA,n)
dataprep$AngleVelocities=rep(NA,n)
dataprep$theta=rep(NA,n)
dataprep$theta_translated=rep(NA,n)
dataprep$VelocityPhase=rep(NA,n)

for (id in unique(dataprep$ID)) {
  
  #filter data with specific id
  sub_ind=(dataprep$ID==id)
  sub_data=dataprep[sub_ind,]
  n_sub=length(sub_data$time)
  
  #time steps
  dtimes=sub_data[2:n_sub,"time"]-sub_data[1:(n_sub-1),"time"]
  
  #step lengths
  dx=sub_data[2:n_sub,"x"]-sub_data[1:(n_sub-1),"x"]
  dy=sub_data[2:n_sub,"y"]-sub_data[1:(n_sub-1),"y"]
  
  #matrix of empirical velocity
  vexp_df=cbind(dx/dtimes,dy/dtimes)
  
  #matrix of normal vectors
  normal=as.matrix(sub_data[2:n_sub,c("nx","ny")])
  normal_translated=as.matrix(sub_data[2:n_sub,c("nx_translated","ny_translated")])
  
  #angle between velocity and normal vector
  theta=signed_angle(vexp_df,normal)
  theta_translated=signed_angle(vexp_df,normal_translated)
  
  #deviation angle between consecutive velocities
  angle_vel=signed_angle(vexp_df[1:(n_sub-2),],vexp_df[2:(n_sub-1),])
  
  #velocity phase angle
  vel_phase=signed_angle(matrix(rep(c(1,0),each=n_sub-2),ncol=2),vexp_df[1:(n_sub-2),])
  
  #deviation from trajectory parallel to coastline
  phi=ifelse(theta > 0, theta - pi/2, theta + pi/2)
  
  
  #adjust lengths by adding NA when necessary
  angle_vel=c(NA,angle_vel,NA)
  phi=c(NA,phi)
  theta=c(NA,theta)
  theta_translated=c(NA,theta_translated)
  vel_phase=c(NA,vel_phase,NA)
  
  dataprep[sub_ind,"AngleShore"]=phi
  dataprep[sub_ind,"AngleVelocities"]=angle_vel
  dataprep[sub_ind,"theta"]=-theta
  dataprep[sub_ind,"theta_translated"]=-theta_translated
  dataprep[sub_ind,"VelocityPhase"]=vel_phase
}


```

## Plot empirical velocities and deviation angles through time



```{r plot empirical velocities and deviation angles through time}


#highlight regions when the narwhals are exposed to the ship
#get starting times of experiment
start_times <- dataprep %>%
  filter((Type == "intertrial" | Type == "trial") & lag(is.na(Type))) %>% 
  select(time,ID)%>% rename(start_time = time)
#get ending times of experiments
end_times <- dataprep %>%
  filter((Type == "intertrial" | Type == "trial") & lead(is.na(Type))) %>% 
  select(time)%>% rename(end_time = time)
#dataframe with time period when the narwhals are exposed
regions=cbind(start_times,end_times)


#plot with highlight on the periods when the narwhals are exposed
plot_speed=ggplot()+ geom_line(data=dataprep,aes(time,horizontal_speed,col=ID))+ 
  geom_rect(data = regions, 
            aes(xmin = start_time, xmax = end_time, ymin = -Inf, ymax = Inf),
            alpha = 0.3,col="lightblue")+
  facet_grid(ID ~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  scale_color_viridis_d(guide="none")+theme(legend.position="none")+xlab("Time (h)")+ylab("Empirical velocity")+
   theme_minimal()

plot_AngleShore=ggplot()+geom_line(data=dataprep[dataprep$DistanceShore>0.05,],aes(time,AngleShore,col=ID))+
  geom_rect(data = regions, aes(xmin = start_time, xmax = end_time, ymin = -Inf, ymax = Inf),alpha = 0.3,col="lightblue")+
  facet_grid(ID ~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  scale_color_viridis_d(guide="none")+theme(legend.position="none")+xlab("Time (h)")+ylab("Empirical deviation from coastline")+
  theme_minimal()

plot_AngleVelocities=ggplot()+geom_line(data=dataprep,aes(time,AngleVelocities,col=ID))+
  geom_rect(data = regions, aes(xmin = start_time, xmax = end_time, ymin = -Inf, ymax = Inf),alpha = 0.3,col="lightblue")+
  facet_grid(ID ~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  scale_color_viridis_d(guide="none")+theme(legend.position="none")+xlab("Time (h)")+ylab("Empirical deviation between consecutive velocities")+ theme_minimal()

plot_AngleNormal=ggplot()+geom_line(data=dataprep[dataprep$DistanceShore>0.05,],aes(time,theta,col=ID))+
  geom_rect(data = regions, aes(xmin = start_time, xmax = end_time, ymin = -Inf, ymax = Inf),alpha = 0.3,col="lightblue")+
  facet_grid(ID ~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  scale_color_viridis_d(guide="none")+theme(legend.position="none")+xlab("Time (h)")+ylab("Angle between empirical velocity and normal vector")+ theme_minimal()



ggsave(path=plots_folder,"plot_horizontal_speed.png", plot = plot_speed)
ggsave(path=plots_folder,"plot_AngleShore.png", plot = plot_AngleShore)
ggsave(path=plots_folder,"plot_AngleVelocities.png", plot = plot_AngleVelocities)
ggsave(path=plots_folder,"plot_AngleNormal.png", plot = plot_AngleNormal)

```

```{r display plot_vexp , fig.cap="",warning=FALSE}
plot_speed
```

```{r display plot_AngleShore , fig.cap="",warning=FALSE}
plot_AngleShore
plot_AngleVelocities
```

```{r display plot_AngleVelocities , fig.cap="",warning=FALSE}
plot_AngleVelocities
```

## Histograms deviation angles

```{r histogram deviation angles}


AngleShore_histo=ggplot(dataprep[dataprep$DistanceShore>0.05,], aes(x = AngleShore,col=ID)) +
  geom_histogram(fill="white",bins=50)+facet_grid(ID ~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  scale_color_viridis_d(guide="none")+
  theme(legend.position="top")+xlab("Empirical deviation from coastline (rad)")+ theme_minimal()


AngleVelocities_histo=ggplot(dataprep, aes(x = AngleVelocities,col=ID)) +
  geom_histogram(fill="white",bins=50)+facet_grid(ID ~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  scale_color_viridis_d(guide="none")+
  theme(legend.position="top")+xlab("Empirical deviation between consecutive velocities (rad) ")+ theme_minimal()

AngleNormal_histo=ggplot(dataprep[dataprep$DistanceShore>0.05,], aes(x = theta,col=ID)) +
  geom_histogram(fill="white",bins=50)+facet_grid(ID ~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  scale_color_viridis_d(guide="none")+
  theme(legend.position="top")+xlab("Angle between empirical velocity and normal vector (rad) ")+ theme_minimal()


VelocityPhase_histo=ggplot(dataprep, aes(x = VelocityPhase,col=ID)) +
  geom_histogram(fill="white",bins=50)+facet_grid(ID ~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  scale_color_viridis_d(guide="none")+
  theme(legend.position="top")+xlab("Velocity phase angele (rad) ")+ theme_minimal()

ggsave(path=plots_folder,"AngleShore_histo.png", plot = AngleShore_histo)
ggsave(path=plots_folder,"AngleVelocities.png", plot = AngleVelocities_histo)
ggsave(path=plots_folder,"AngleNormal.png", plot = AngleNormal_histo)
ggsave(path=plots_folder,"VelocityPhase.png", plot = VelocityPhase_histo)
```



```{r display AngleShore_histo, fig.cap="",warning=FALSE}
AngleShore_histo
```

```{r display AngleVelocities_histo, fig.cap="",warning=FALSE}
AngleVelocities_histo
```

```{r, display AngleNormal_histo,warning=FALSE}
AngleNormal_histo
```

```{r, display VelocityPhase_histo,warning=FALSE}
VelocityPhase_histo
```

## Empirical velocity and deviation angle depending on ExpShip

```{r plot empirical velocity and deviation angle depending on ExpSHip }


plot_AngleVelocitiesExp=ggplot()+geom_point(data=dataprep,aes(ExpShip,AngleVelocities,col=ID))+
  facet_grid(ID ~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  scale_color_viridis_d(guide="none")+theme(legend.position="none")+xlab("Exposure to ship (km)")+ylab("Empirical deviation between consecutive velocities")

ggsave(path=plots_folder,"plot_AngleVelocities_ExpShip.png", plot = plot_AngleVelocitiesExp)

plot_speedExp=ggplot()+geom_point(data=dataprep,aes(ExpShip,horizontal_speed,col=ID))+
  facet_grid(ID ~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  scale_color_viridis_d(guide="none")+theme(legend.position="none")+xlab("Exposure to ship (km)")+ylab("Empirical velocity")

ggsave(path=plots_folder,"plot_speed_ExpShip.png", plot = plot_speedExp)
```

```{r display plot_AngleVelocitiesExp, fig.cap=""}
plot_AngleVelocitiesExp
```

```{r display plot_vexpExp, fig.cap=""}
plot_speedExp
```

No clear pattern can be identified from these plots.


## Empirical velocity and deviation angles depending on Distance to shore

```{r plot empirical velocity and deviation angle depending on DistanceShore }

plot_AngleShoreDistance=ggplot()+geom_point(data=dataprep,aes(DistanceShore,AngleShore,col=ID))+
  facet_grid(ID ~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  scale_color_viridis_d(guide="none")+theme(legend.position="none")+xlab("Distance to shore (km)")+ylab("Empirical deviation from coastline")


ggsave(path=plots_folder,"plot_AngleShore_DistanceShore.png", plot = plot_AngleShoreDistance)


plot_AngleVelocitiesDistance=ggplot()+geom_point(data=dataprep,aes(DistanceShore,AngleVelocities,col=ID))+
  facet_grid(ID ~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  scale_color_viridis_d(guide="none")+theme(legend.position="none")+xlab("Distance to shore (km)")+ylab("Empirical deviation between consecutive velocities")


ggsave(path=plots_folder,"plot_AngleVelocities_DistanceShore.png", plot = plot_AngleVelocitiesDistance)

plot_speedDistance=ggplot()+geom_point(data=dataprep,aes(DistanceShore,horizontal_speed,col=ID))+
  facet_grid(ID ~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  scale_color_viridis_d(guide="none")+theme(legend.position="none")+xlab("Distance to shore (km)")+ylab("Empirical velocity")

ggsave(path=plots_folder,"plot_speed_DistanceShore.png", plot = plot_speedDistance)
```

```{r display plot_AngleShoreDistance, fig.cap=""}
plot_AngleShoreDistance
```


```{r display plot_AngleVelocitiesDistance, fig.cap=""}
plot_AngleVelocitiesDistance
```


```{r display plot_vexpDistance, fig.cap=""}
plot_speedDistance
```

## Deviation angles and velocity as a smooth function of DistanceShore


```{=tex}
We are using \texttt{geom\_smooth} function to get a "smooth" version of the previous plots. The smooth approximation is computed with \texttt{gam} package and cubic spline basis functions.
```

```{r deviation angles and velocity as a smooth function of DistanceShore}

# Plot smoothed AngleSHore
plot_AngleShoreDistanceSmoothed <-  ggplot()+ geom_smooth(data=dataprep,aes(DistanceShore,abs(AngleShore),col=ID))+
  facet_grid(ID ~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  scale_color_viridis_d(guide="none")+theme(legend.position="none")+xlab("Distance to shore (km)")+ylab("Empirical deviation from coastline")

# Plot smoothed AngleVelocities
plot_AngleVelocitiesDistanceSmoothed <-  ggplot()+ geom_smooth(data=dataprep,aes(DistanceShore,abs(AngleVelocities),col=ID))+
  facet_grid(ID ~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  scale_color_viridis_d(guide="none")+theme(legend.position="none")+xlab("Distance to shore (km)")+ylab("Empirical deviation between consecutive velocities")

#Plot smoothed speed
plot_speedDistanceSmoothed <- ggplot() +geom_smooth(data=dataprep,aes(DistanceShore,horizontal_speed,col=ID))+
  facet_grid(ID ~ ., labeller = as_labeller(c("Asgeir" = "A1", "Frederik" = "A2", "Helge18" = "A3", "Kyrri" = "A4", "Nemo" = "A5", "Siggi" = "A6"))) +
  scale_color_viridis_d(guide = "none") +
  theme(legend.position = "none") +
  xlab("Distance to shore (km)") +
  ylab("Empirical velocity")
```



```{r display plot_AngleShoreDistanceSmoothed, fig.cap=""}
plot_AngleShoreDistanceSmoothed
```

```{r display plot_AngleVelocitiesDistanceSmoothed, fig.cap=""}
plot_AngleVelocitiesDistanceSmoothed
```

```{r display plot_vexpDistanceSmoothed, fig.cap=""}
plot_speedDistanceSmoothed
```


```{=tex}
The increase in deviation angle from coastline for small values of Distance to shore might indicate a rotation of the narwhals at a certain threshold. However, it may also be due to the points on land ($2 \%$ of the data), that is the points for which \texttt{DistanceShore} is $0$. This can be checked by removing these points from the plot.
```

## Same plots without points on land

```{r plot empirical velocities and deviation angles without points on land}
# Plot smoothed AngleSHore
plot_AngleShoreDistanceSmoothed <-  ggplot()+
  geom_smooth(data=dataprep[dataprep$DistanceShore>0,],aes(DistanceShore,abs(AngleShore),col=ID))+
  facet_grid(ID ~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  scale_color_viridis_d(guide="none")+
  theme(legend.position="none")+xlab("Distance to shore (km)")+
  ylab("Empirical deviation from coastline")

# Plot smoothed AngleVelocities
plot_AngleVelocitiesDistanceSmoothed <-  ggplot()+
  geom_smooth(data=dataprep[dataprep$DistanceShore>0,],aes(DistanceShore,abs(AngleVelocities),col=ID))+
  facet_grid(ID ~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  scale_color_viridis_d(guide="none")+theme(legend.position="none")+xlab("Distance to shore (km)")+
  ylab("Empirical deviation between consecutive velocities")

#Plot smoothed vexp
plot_speedDistanceSmoothed <- ggplot() +geom_smooth(data=dataprep[dataprep$DistanceShore>0,],aes(DistanceShore,horizontal_speed,col=ID))+
  facet_grid(ID ~ ., labeller = as_labeller(c("Asgeir" = "A1", "Frederik" = "A2", "Helge18" = "A3", "Kyrri" = "A4", "Nemo" = "A5", "Siggi" = "A6"))) +
  scale_color_viridis_d(guide = "none") +
  theme(legend.position = "none") +
  xlab("Distance to shore (km)") +
  ylab("Empirical velocity")

```

```{r display plot_AngleShoreDistanceSmoothed without points on land, fig.cap=""}
plot_AngleShoreDistanceSmoothed
```

```{r display plot_AngleVelocitiesDistanceSmoothed without points on land, fig.cap=""}
plot_AngleVelocitiesDistanceSmoothed
```

```{r display plot_vexpDistanceSmoothed without points on land, fig.cap=""}
plot_speedDistanceSmoothed
```



# Visualize individual tracks


## Plot individual tracks on the map

```{r}

for (id in unique(dataprep$ID)) {
  sub_data=dataprep[dataprep$ID==id,]
 mapID=milne_land_map + 
  geom_point(sub_data[,c("ID","Long","Lat","time")],
             mapping=aes(Long, Lat, col = time),size= 1,alpha=0.5) +
  scale_color_viridis_c()
  
  ggsave(path=plots_folder,paste(id,"map_track.png",sep="_"), 
         plot =mapID,width=10,height=5)
  
}

```

## Plot each individual track along with nearest shore points


```{r individual tracks}

for (id in unique(dataprep$ID)) {
  sub_data=dataprep[dataprep$ID==id,]
  id_track=ggplot()+geom_sf(data=updated_scoresby_sound_utm$geometry,fill="grey")+
    coord_sf(datum=st_crs(32626))+
  geom_point(data=sub_data,aes(px,py),shape=5,size=0.1,col="red")+
  geom_point(data=sub_data,aes(x,y,col=time),size=0.1)+
    geom_path(data=sub_data,mapping=aes(x,y),linewidth=0.1)+
    geom_point(data = sub_data %>% filter(!duplicated(ID)),
             aes(x,y,col=ID), shape = 3, size = 4,col = "red")+
    scale_color_viridis_c()
  
  ggsave(path=plots_folder,paste(id,"track.png",sep="_"), 
         plot =id_track)
  
}

```

```{r display one track, fig.cap="Example of individual track with computed nearest shore points"}
id_track
```

## Plot distance to shore histogram for each narwhal

```{r distance shore histogram}
Dshore_histo=ggplot(dataprep, aes(x = DistanceShore)) +
  geom_histogram(fill="white",color="black",bins=50)+
  facet_grid(ID ~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  theme(legend.position="none")+xlab("Distance to shore (km)")


ggsave(path=plots_folder,"Dshore_histo.png", plot = Dshore_histo)
```

```{r display Dshore_histo, fig.cap="Histograms of distance to shore"}
Dshore_histo
```
## Plot distance to ship histogram for each narwhal


We also plot the histogram of the Dist_Ship variable to understand better its distribution.


```{r distance ship histogram}

Dship_histo=ggplot(dataprep, aes(x = Dist_Ship)) +
  geom_histogram(fill="white",col="black",bins=30)+
  facet_grid(ID ~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  theme(legend.position="none")+xlab("Distance to ship (km)")

ggsave(path=plots_folder,"Dship_histo.png", plot = Dship_histo)

```


```{r display Dship_histo, fig.cap="Histograms of distance to ship"}
Dship_histo
```

# Tracks before and after exposure to ship

## Split between tracks before and after exposure

```{r split tracks}

tagtime=24


dataBE24=data.frame()
for (id in unique(data$ID)) {
  narwhalData=dataprep[dataprep$ID==id,]
  maxtime <- min(narwhalData$time[(narwhalData$LOS == 1)])
  dataBE24 =rbind(dataBE24,subset(narwhalData, !(time > (maxtime-1)) & (time>tagtime)))
}

dataBE12=data.frame()
for (id in unique(data$ID)) {
  narwhalData=dataprep[dataprep$ID==id,]
  maxtime <- min(narwhalData$time[(narwhalData$LOS == 1)])
  dataBE12 =rbind(dataBE12,subset(narwhalData, !(time > (maxtime-1)) & (time>tagtime/2)))
}

dataAE=data.frame()
for (id in unique(dataprep$ID)) {
  narwhalData=dataprep[dataprep$ID==id,]
  maxtime <- min(narwhalData$time[(narwhalData$LOS == 1)])
  dataAE =rbind(dataAE,subset(narwhalData, (time >= maxtime) & (time>tagtime)))
}

```

```{r}
#number of data points for each individual
for (id in unique(data$ID)) {
  narwhalDataBE=dataBE12[dataBE12$ID==id,]
  narwhalDataAE=dataAE[dataAE$ID==id,]
  cat(id," : ", length(narwhalDataBE$time)," GPS measurement before exposure and ", length(narwhalDataAE$time)," after exposure.\n",sep="")
}
```


## Plot data before and after exposure

```{r plots before and after exposure}
pBE24=milne_land_map + 
  geom_point(dataBE24[,c("ID","Long","Lat","time")],
             mapping=aes(Long, Lat, col = ID),size= 0.5,alpha=1) +
   geom_path(dataBE24[,c("ID","Long","Lat","time")],mapping=aes(Long,Lat,col=ID),linewidth=0.1)+
  geom_point(data = dataBE24[,c("ID","Long","Lat","time")] %>% filter(!duplicated(ID)),
             aes(x = Long, y = Lat,col=ID), shape = 3, size = 4,col = "red")+
  scale_color_viridis_d(labels=c("A1","A2","A3","A4","A5","A6"))

pBE12=milne_land_map + 
  geom_point(dataBE12[,c("ID","Long","Lat","time")],
             mapping=aes(Long, Lat, col = ID),size= 0.5,alpha=1) +
   geom_path(dataBE12[,c("ID","Long","Lat","time")],mapping=aes(Long,Lat,col=ID),linewidth=0.1)+
  geom_point(data = dataBE12[,c("ID","Long","Lat","time")] %>% filter(!duplicated(ID)),
             aes(x = Long, y = Lat,col=ID), shape = 3, size = 4,col = "red")+
  scale_color_viridis_d(labels=c("A1","A2","A3","A4","A5","A6"))

pAE=milne_land_map + 
  geom_point(dataAE[,c("ID","Long","Lat","time")],
             mapping=aes(Long, Lat, col = ID),size= 0.5,alpha=1) +
   geom_path(dataAE[,c("ID","Long","Lat","time")],mapping=aes(Long,Lat,col=ID),linewidth=0.1)+
  geom_point(data = dataAE[,c("ID","Long","Lat","time")] %>% filter(!duplicated(ID)),
             aes(x = Long, y = Lat,col=ID), shape = 3, size = 4,col = "red")+
  scale_color_viridis_d(labels=c("A1","A2","A3","A4","A5","A6"))

ggsave(path=plots_folder,"tracksBE12.png",pBE12,width=10,height=5)
ggsave(path=plots_folder,"tracksBE24.png",pBE24,width=10,height=5)
ggsave(path=plots_folder,"tracksAE.png",pAE,width=10,height=5)
```

```{r display pBE1, fig.cap="Tracks before exposure, 24h after tagging"}
pBE12
```

```{r display pBE2, fig.cap="Tracks before exposure, 12h after tagging"}
pBE24
```

```{r display pAE, fig.cap="Tracks after exposure"}
pAE
```

# Save preprocessed data frames as csv files for further smoothSDE analysis

```{r save preprocessed data}
# Set the path to the directory containing the raw data for narwhals
preprocessed_narwhal_data_path <- here(file.path("Data","preprocessed_data","narwhals"))

write.csv(dataprep,file.path(preprocessed_narwhal_data_path,"allData.csv"))
write.csv(dataBE12,file.path(preprocessed_narwhal_data_path,"DataBE12.csv"))
write.csv(dataBE24,file.path(preprocessed_narwhal_data_path,"DataBE24.csv"))
write.csv(dataAE,file.path(preprocessed_narwhal_data_path,"DataAE.csv"))
```



## Plot ship exposure 12h after tagging

```{r plot real exposure}

cropped_data=dataprep[dataprep$time>12,]
pExpShip=ggplot(cropped_data,aes(time,ExpShip,col=ID))+geom_line(color="black")+
  facet_grid(ID~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  xlab("Time (h)")+ylab("Exposure to ship")+
   theme(
    axis.text = element_text(size = 12),   # Increase tick size
    axis.title = element_text(size = 16)  # Increase label size
  )



ggsave(path=plots_folder,"realExpShip_through_time.pdf", plot=pExpShip)
```

```{r display pExp, fig.cap="Measured exposure to ship through time"}
pExpShip
```
## Plot shore exposure

```{r}
D_low=0.07
D_up=3
df=cropped_data
df[df$DistanceShore<D_low,"Ishore"]=1/D_low
df[df$DistanceShore>D_up,"Ishore"]=0

pIshore=ggplot(df,aes(time,Ishore,col=ID))+ geom_line(color="black")+facet_grid(ID ~.,labeller=as_labeller(c("Asgeir"="A1","Frederik"="A2","Helge18"="A3","Kyrri"="A4","Nemo"="A5","Siggi"="A6")))+
  theme(legend.position="none")+xlab("Time (h)")+ylab("Inverse distance to shore")



ggsave(path=plots_folder,"realIshore_through_time.png", plot=pIshore)
```

```{r}
pIshore
```

